<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETA SMART FINANCE PRO v2.0 - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø³ÙŠØ· Ø§Ù„Ù…Ø±Ù† Ø§Ù„Ù…ØªØ·ÙˆØ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap');
        * { 
            font-family: 'Cairo', sans-serif;
            box-sizing: border-box;
        }
        body { 
            margin: 0; 
            padding: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            min-height: 100vh;
        }
        
        @media print {
            body { 
                print-color-adjust: exact; 
                -webkit-print-color-adjust: exact; 
                margin: 0;
                padding: 0;
                background: white !important;
            }
            .print-hidden { display: none !important; }
            .print-only { display: block !important; }
            .print-container { 
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 20mm !important;
                background: white !important;
            }
            @page {
                size: A4;
                margin: 15mm;
            }
            .glass-card {
                background: white !important;
                border: 1px solid #ccc !important;
            }
        }
        
        .print-only { display: none; }
        
        /* Modern Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .glass-dark {
            background: rgba(99, 102, 241, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        /* Premium Gradient Backgrounds - BETA Corporate Colors */
        .gradient-primary {
            background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
        }
        
        .gradient-info {
            background: linear-gradient(135deg, #DC143C 0%, #A52A2A 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #DC143C 0%, #FF6347 100%);
        }
        
        .gradient-dark {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }
        
        /* Modern Input Styles */
        .modern-input {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .modern-input:focus {
            border-color: #DC143C;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.15);
            transform: translateY(-2px);
        }
        
        .modern-input:hover {
            border-color: #FF6B6B;
        }
        
        /* Premium Button Styles */
        .btn-premium {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-premium::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-premium:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Modern Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-pro {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .badge-new {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
            border-radius: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in { animation: slideIn 0.4s ease-out; }

        .comparison-table td, .comparison-table th {
            padding: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .comparison-highlight-positive {
            background-color: #d1fae5;
            font-weight: bold;
        }
        
        .comparison-highlight-negative {
            background-color: #fee2e2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BETA SMART FINANCE ENGINE - FLEXIBLE PAYMENT SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class SmartPaymentEngine {
            constructor(unitValue, cashDiscountRate, discountRate, baseDate = new Date()) {
                this.unitValue = unitValue;
                this.cashDiscountRate = cashDiscountRate / 100;
                this.discountRate = discountRate / 100;
                this.cashValue = unitValue * (1 - this.cashDiscountRate);
                this.baseDate = new Date(baseDate);
                this.baseDate.setHours(0, 0, 0, 0);
            }

            // â•â•â• XNPV IMPLEMENTATION â•â•â•
            calculateXNPV(rate, cashFlows) {
                if (cashFlows.length === 0) return 0;
                
                return cashFlows.reduce((npv, cf) => {
                    const cfDate = new Date(cf.date);
                    cfDate.setHours(0, 0, 0, 0);
                    
                    const days = Math.round((cfDate - this.baseDate) / (1000 * 60 * 60 * 24));
                    const years = days / 365;
                    
                    if (days <= 0) {
                        return npv + cf.amount;
                    }
                    
                    return npv + cf.amount / Math.pow(1 + rate, years);
                }, 0);
            }

            calculatePVWithDate(amount, paymentDate) {
                const payment = new Date(paymentDate);
                payment.setHours(0, 0, 0, 0);
                const days = Math.round((payment - this.baseDate) / (1000 * 60 * 60 * 24));
                const years = days / 365;
                
                if (days <= 0) {
                    return amount;
                }
                
                return amount / Math.pow(1 + this.discountRate, years);
            }

            addMonths(date, months) {
                const d = new Date(date);
                d.setMonth(d.getMonth() + months);
                return d;
            }

            // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø£Ø´Ù‡Ø± Ù…Ø¹ Ø¶Ø¨Ø· Ø§Ù„ÙŠÙˆÙ… Ø¹Ù„Ù‰ 1 Ø£Ùˆ 15 Ø¨Ø´ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚
            addMonthsWithDay(date, months, day) {
                const d = new Date(date);
                // Ù†Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                let newMonth = d.getMonth() + months;
                let newYear = d.getFullYear();
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø£Ø´Ù‡Ø±
                while (newMonth > 11) {
                    newMonth -= 12;
                    newYear++;
                }
                while (newMonth < 0) {
                    newMonth += 12;
                    newYear--;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ ØªØ§Ø±ÙŠØ® Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø¶Ø¨Ø· Ø§Ù„ÙˆÙ‚Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡Ø± Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ timezone
                const result = new Date(newYear, newMonth, day, 12, 0, 0);
                
                return result;
            }
            
            // Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ timezone)
            formatDateLocal(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // â•â•â• FIND EQUAL INSTALLMENT â•â•â•
            findEqualInstallmentXNPV(targetPV, dates) {
                let low = 0, high = targetPV * 2, tolerance = 0.1;
                const maxIterations = 100;
                let iterations = 0;

                while (high - low > tolerance && iterations < maxIterations) {
                    const mid = (low + high) / 2;
                    
                    let calculatedPV = 0;
                    for (let i = 0; i < dates.length; i++) {
                        calculatedPV += this.calculatePVWithDate(mid, dates[i]);
                    }
                    
                    if (calculatedPV < targetPV) {
                        low = mid;
                    } else {
                        high = mid;
                    }
                    
                    iterations++;
                }
                
                return (low + high) / 2;
            }

            // â•â•â• EQUAL INSTALLMENTS â•â•â•
            calculateEqualInstallments(params) {
                const {
                    downPayment,
                    downPaymentDate,
                    numberOfYears,
                    frequency = 4,
                    annualPayments = [],
                    semiannualPayments = [],
                    quarterlyPayments = [],
                    quarterlyStartDate = null,
                    installmentDay = 1 // ÙŠÙˆÙ… Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø³Ø· (1 Ø£Ùˆ 15)
                } = params;
                
                const basePaymentDate = downPaymentDate || this.baseDate;
                
                let knownPV = downPayment;
                const schedule = [{
                    id: 0,
                    type: 'Ù…Ù‚Ø¯Ù…',
                    date: this.formatDateLocal(basePaymentDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];

                let paymentId = 1;

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ©
                annualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(basePaymentDate, (index + 1) * 12, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©
                semiannualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(basePaymentDate, (index + 1) * 6, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© (Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©)
                quarterlyPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(basePaymentDate, (index + 1) * 3, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const remainingPV = this.cashValue - knownPV;
                // ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù…Ø¹ Ø¶Ø¨Ø· Ø§Ù„ÙŠÙˆÙ… Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±
                let startDate;
                if (quarterlyStartDate) {
                    // Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯Ø§Ù‹ØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© ÙÙ‚Ø· ÙˆÙ†Ø¶Ø¨Ø· Ø§Ù„ÙŠÙˆÙ…
                    const tempDate = new Date(quarterlyStartDate);
                    // Ø¶Ø¨Ø· Ø§Ù„ÙˆÙ‚Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡Ø± Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ timezone
                    startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                } else {
                    startDate = this.addMonthsWithDay(basePaymentDate, 3, installmentDay);
                }
                
                const numberOfQuarters = numberOfYears * frequency;
                const quarterlyDates = [];
                for (let i = 0; i < numberOfQuarters; i++) {
                    quarterlyDates.push(this.addMonthsWithDay(startDate, i * (12 / frequency), installmentDay));
                }

                const installmentAmount = this.findEqualInstallmentXNPV(remainingPV, quarterlyDates);

                quarterlyDates.forEach((date, index) => {
                    const pv = this.calculatePVWithDate(installmentAmount, date);
                    schedule.push({
                        id: paymentId++,
                        type: `Ù‚Ø³Ø· Ù…ÙˆØ­Ø¯ ${index + 1}`,
                        date: this.formatDateLocal(date),
                        amount: installmentAmount,
                        pv,
                        discount: installmentAmount - pv
                    });
                });

                const verification = this.verifyScheduleXNPV(schedule);

                return {
                    pattern: 'equal',
                    patternName: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…ÙˆØ­Ø¯',
                    downPayment,
                    installmentAmount,
                    numberOfInstallments: quarterlyDates.length,
                    annualPayments: annualPayments.length,
                    semiannualPayments: semiannualPayments.length,
                    quarterlyPayments: quarterlyPayments.length,
                    frequency,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            // â•â•â• DECREASING PAYMENTS â•â•â•
            calculateDecreasingPayments(params) {
                const {
                    downPayment,
                    numberOfYears,
                    frequency = 4,
                    decreaseRate = 2,
                    annualPayments = [],
                    semiannualPayments = [],
                    quarterlyPayments = [],
                    quarterlyStartDate = null,
                    installmentDay = 1
                } = params;

                let knownPV = downPayment;
                const schedule = [{
                    id: 0,
                    type: 'Ù…Ù‚Ø¯Ù…',
                    date: this.formatDateLocal(this.baseDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];

                let paymentId = 1;

                annualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 12, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                semiannualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 6, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© (Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©)
                quarterlyPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 3, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const remainingPV = this.cashValue - knownPV;
                let startDate;
                if (quarterlyStartDate) {
                    const tempDate = new Date(quarterlyStartDate);
                    startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                } else {
                    startDate = this.addMonthsWithDay(this.baseDate, 3, installmentDay);
                }
                
                const numberOfQuarters = numberOfYears * frequency;
                const quarterlyDates = [];
                for (let i = 0; i < numberOfQuarters; i++) {
                    quarterlyDates.push(this.addMonthsWithDay(startDate, i * (12 / frequency), installmentDay));
                }

                const baseInstallment = this.findBaseInstallmentDecreasing(remainingPV, quarterlyDates, decreaseRate / 100);

                quarterlyDates.forEach((date, index) => {
                    const amount = baseInstallment * Math.pow(1 - decreaseRate / 100, index);
                    const pv = this.calculatePVWithDate(amount, date);
                    schedule.push({
                        id: paymentId++,
                        type: `Ù‚Ø³Ø· Ù…ØªÙ†Ø§Ù‚Øµ ${index + 1}`,
                        date: this.formatDateLocal(date),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const verification = this.verifyScheduleXNPV(schedule);

                return {
                    pattern: 'decreasing',
                    patternName: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªÙ†Ø§Ù‚ØµØ©',
                    downPayment,
                    baseInstallment,
                    decreaseRate,
                    numberOfInstallments: quarterlyDates.length,
                    annualPayments: annualPayments.length,
                    semiannualPayments: semiannualPayments.length,
                    quarterlyPayments: quarterlyPayments.length,
                    frequency,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            findBaseInstallmentDecreasing(targetPV, dates, decreaseRate) {
                let low = 0, high = targetPV * 2, tolerance = 0.1;
                const maxIterations = 100;
                let iterations = 0;

                while (high - low > tolerance && iterations < maxIterations) {
                    const mid = (low + high) / 2;
                    
                    let calculatedPV = 0;
                    for (let i = 0; i < dates.length; i++) {
                        const amount = mid * Math.pow(1 - decreaseRate, i);
                        calculatedPV += this.calculatePVWithDate(amount, dates[i]);
                    }
                    
                    if (calculatedPV < targetPV) {
                        low = mid;
                    } else {
                        high = mid;
                    }
                    
                    iterations++;
                }
                
                return (low + high) / 2;
            }

            // â•â•â• GRADUATED PAYMENTS â•â•â•
            calculateGraduatedPayments(params) {
                const {
                    downPayment,
                    numberOfYears,
                    frequency = 4,
                    growthRate = 3,
                    annualPayments = [],
                    semiannualPayments = [],
                    quarterlyPayments = [],
                    quarterlyStartDate = null,
                    installmentDay = 1
                } = params;

                let knownPV = downPayment;
                const schedule = [{
                    id: 0,
                    type: 'Ù…Ù‚Ø¯Ù…',
                    date: this.formatDateLocal(this.baseDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];

                let paymentId = 1;

                annualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 12, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                semiannualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 6, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© (Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©)
                quarterlyPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 3, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const remainingPV = this.cashValue - knownPV;
                let startDate;
                if (quarterlyStartDate) {
                    const tempDate = new Date(quarterlyStartDate);
                    startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                } else {
                    startDate = this.addMonthsWithDay(this.baseDate, 3, installmentDay);
                }
                
                const numberOfQuarters = numberOfYears * frequency;
                const quarterlyDates = [];
                for (let i = 0; i < numberOfQuarters; i++) {
                    quarterlyDates.push(this.addMonthsWithDay(startDate, i * (12 / frequency), installmentDay));
                }

                const baseInstallment = this.findBaseInstallmentGraduated(remainingPV, quarterlyDates, growthRate / 100);

                quarterlyDates.forEach((date, index) => {
                    const amount = baseInstallment * Math.pow(1 + growthRate / 100, index);
                    const pv = this.calculatePVWithDate(amount, date);
                    schedule.push({
                        id: paymentId++,
                        type: `Ù‚Ø³Ø· Ù…ØªØ²Ø§ÙŠØ¯ ${index + 1}`,
                        date: this.formatDateLocal(date),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const verification = this.verifyScheduleXNPV(schedule);

                return {
                    pattern: 'graduated',
                    patternName: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ²Ø§ÙŠØ¯Ø©',
                    downPayment,
                    baseInstallment,
                    growthRate,
                    numberOfInstallments: quarterlyDates.length,
                    annualPayments: annualPayments.length,
                    semiannualPayments: semiannualPayments.length,
                    quarterlyPayments: quarterlyPayments.length,
                    frequency,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            findBaseInstallmentGraduated(targetPV, dates, growthRate) {
                let low = 0, high = targetPV * 2, tolerance = 0.1;
                const maxIterations = 100;
                let iterations = 0;

                while (high - low > tolerance && iterations < maxIterations) {
                    const mid = (low + high) / 2;
                    
                    let calculatedPV = 0;
                    for (let i = 0; i < dates.length; i++) {
                        const amount = mid * Math.pow(1 + growthRate, i);
                        calculatedPV += this.calculatePVWithDate(amount, dates[i]);
                    }
                    
                    if (calculatedPV < targetPV) {
                        low = mid;
                    } else {
                        high = mid;
                    }
                    
                    iterations++;
                }
                
                return (low + high) / 2;
            }

            // â•â•â• CUSTOM DISTRIBUTION â•â•â•
            calculateCustomDistribution(params) {
                const {
                    downPayment,
                    customPayments = [],
                    quarterlyYears = 0,
                    quarterlyStartDate = null,
                    installmentDay = 1
                } = params;
                
                let knownPV = downPayment;
                const schedule = [{
                    id: 0,
                    type: 'Ù…Ù‚Ø¯Ù…',
                    date: this.formatDateLocal(this.baseDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];

                let paymentId = 1;

                customPayments.forEach((payment) => {
                    const baseAmount = payment.amount;

                    if (payment.frequency === 'once') {
                        const paymentDate = payment.startDate ? new Date(payment.startDate) : new Date();
                        const pv = this.calculatePVWithDate(baseAmount, paymentDate);
                        knownPV += pv;
                        
                        schedule.push({
                            id: paymentId++,
                            type: payment.type || 'Ø¯ÙØ¹Ø©',
                            date: this.formatDateLocal(paymentDate),
                            amount: baseAmount,
                            pv,
                            discount: baseAmount - pv
                        });
                    } else {
                        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                        let monthsInterval;
                        switch (payment.frequency) {
                            case 'annual':
                                monthsInterval = 12;
                                break;
                            case 'semiannual':
                                monthsInterval = 6;
                                break;
                            case 'quarterly':
                                monthsInterval = 3;
                                break;
                            default:
                                monthsInterval = 12;
                        }
                        
                        const numberOfPayments = payment.numberOfPayments || 1;
                        const startDate = payment.startDate ? new Date(payment.startDate) : new Date();
                        
                        for (let i = 0; i < numberOfPayments; i++) {
                            const paymentDate = this.addMonthsWithDay(startDate, i * monthsInterval, installmentDay);
                            const pv = this.calculatePVWithDate(baseAmount, paymentDate);
                            knownPV += pv;
                            
                            schedule.push({
                                id: paymentId++,
                                type: `${payment.type || 'Ø¯ÙØ¹Ø©'} ${i + 1}`,
                                date: this.formatDateLocal(paymentDate),
                                amount: baseAmount,
                                pv,
                                discount: baseAmount - pv
                            });
                        }
                    }
                });

                if (quarterlyYears > 0) {
                    const remainingPV = this.cashValue - knownPV;
                    let startDate;
                    if (quarterlyStartDate) {
                        const tempDate = new Date(quarterlyStartDate);
                        startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                    } else {
                        startDate = this.addMonthsWithDay(this.baseDate, 3, installmentDay);
                    }
                    
                    const numberOfQuarters = quarterlyYears * 4;
                    const quarterlyDates = [];
                    for (let i = 0; i < numberOfQuarters; i++) {
                        quarterlyDates.push(this.addMonthsWithDay(startDate, i * 3, installmentDay));
                    }

                    const quarterlyInstallment = this.findEqualInstallmentXNPV(remainingPV, quarterlyDates);

                    quarterlyDates.forEach((date, index) => {
                        const pv = this.calculatePVWithDate(quarterlyInstallment, date);
                        schedule.push({
                            id: paymentId++,
                            type: `Ù‚Ø³Ø· Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ ${index + 1}`,
                            date: this.formatDateLocal(date),
                            amount: quarterlyInstallment,
                            pv,
                            discount: quarterlyInstallment - pv
                        });
                    });
                }

                const verification = this.verifyScheduleXNPV(schedule);

                return {
                    pattern: 'custom',
                    patternName: 'Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®ØµØµ',
                    downPayment,
                    customPayments,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            // â•â•â• BASE SYSTEM â•â•â•
            calculateBaseSystem(baseSystemConfig, unitValue) {
                if (!baseSystemConfig) return null;

                const downPaymentDate = baseSystemConfig.downPaymentDate 
                    ? new Date(baseSystemConfig.downPaymentDate) 
                    : this.baseDate;

                const downPayment = baseSystemConfig.downPaymentIsPercentage 
                    ? unitValue * (baseSystemConfig.downPaymentValue / 100)
                    : baseSystemConfig.downPaymentValue;

                const annualPayments = (baseSystemConfig.annualPayments || []).map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date ? new Date(p.date) : null
                }));

                const semiannualPayments = (baseSystemConfig.semiannualPayments || []).map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date ? new Date(p.date) : null
                }));

                const quarterlyPayments = (baseSystemConfig.quarterlyPayments || []).map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date ? new Date(p.date) : null
                }));

                return this.calculateEqualInstallments({
                    downPayment,
                    downPaymentDate,
                    numberOfYears: baseSystemConfig.quarterlyYears,
                    frequency: 4,
                    annualPayments,
                    semiannualPayments,
                    quarterlyPayments,
                    quarterlyStartDate: null
                });
            }

            // â•â•â• IMPLIED DISCOUNT RATE â•â•â•
            calculateImpliedDiscountRate(baseSystem, unitValue) {
                const targetPV = this.cashValue;
                const payments = [];
                
                const downPaymentDate = baseSystem.downPaymentDate 
                    ? new Date(baseSystem.downPaymentDate) 
                    : this.baseDate;
                
                const downPayment = baseSystem.downPaymentIsPercentage 
                    ? unitValue * (baseSystem.downPaymentValue / 100)
                    : baseSystem.downPaymentValue;
                    
                payments.push({ amount: downPayment, date: downPaymentDate });
                
                // Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ©
                if (baseSystem.annualPayments && baseSystem.annualPayments.length > 0) {
                    baseSystem.annualPayments.forEach((payment, index) => {
                        const date = payment.date 
                            ? new Date(payment.date) 
                            : this.addMonths(downPaymentDate, (index + 1) * 12);
                        const amount = payment.isPercentage 
                            ? unitValue * (payment.value / 100)
                            : payment.value;
                        payments.push({ amount, date });
                    });
                }

                // Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù†ØµÙ Ø§Ù„Ø³Ù†ÙˆÙŠØ©
                if (baseSystem.semiannualPayments && baseSystem.semiannualPayments.length > 0) {
                    baseSystem.semiannualPayments.forEach((payment, index) => {
                        const date = payment.date 
                            ? new Date(payment.date) 
                            : this.addMonths(downPaymentDate, (index + 1) * 6);
                        const amount = payment.isPercentage 
                            ? unitValue * (payment.value / 100)
                            : payment.value;
                        payments.push({ amount, date });
                    });
                }

                // Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                if (baseSystem.quarterlyPayments && baseSystem.quarterlyPayments.length > 0) {
                    baseSystem.quarterlyPayments.forEach((payment, index) => {
                        const date = payment.date 
                            ? new Date(payment.date) 
                            : this.addMonths(downPaymentDate, (index + 1) * 3);
                        const amount = payment.isPercentage 
                            ? unitValue * (payment.value / 100)
                            : payment.value;
                        payments.push({ amount, date });
                    });
                }
                
                let knownAmount = payments.reduce((sum, p) => sum + p.amount, 0);
                let remainingAmount = unitValue - knownAmount;
                
                const numberOfQuarters = baseSystem.quarterlyYears * 4;
                const quarterlyAmount = remainingAmount / numberOfQuarters;
                
                for (let i = 0; i < numberOfQuarters; i++) {
                    const date = this.addMonths(downPaymentDate, (i + 1) * 3);
                    payments.push({ amount: quarterlyAmount, date });
                }
                
                return this.findDiscountRateXNPV(payments, targetPV);
            }

            findDiscountRateXNPV(payments, targetPV, tolerance = 0.00001) {
                let lowRate = 0.00;
                let highRate = 0.50;
                let iterations = 0;
                const maxIterations = 100;
                
                const cashFlows = payments.map(p => ({
                    date: p.date,
                    amount: p.amount
                }));

                while (highRate - lowRate > tolerance && iterations < maxIterations) {
                    const midRate = (lowRate + highRate) / 2;
                    
                    const calculatedPV = this.calculateXNPV(midRate, cashFlows);
                    
                    if (calculatedPV < targetPV) {
                        highRate = midRate;
                    } else {
                        lowRate = midRate;
                    }
                    
                    iterations++;
                }
                
                const finalRate = (lowRate + highRate) / 2;
                return finalRate * 100;
            }

            // â•â•â• VERIFICATION â•â•â•
            verifyScheduleXNPV(schedule) {
                const cashFlows = schedule.map(p => ({
                    date: new Date(p.date),
                    amount: p.amount
                }));

                const totalPV = this.calculateXNPV(this.discountRate, cashFlows);
                const totalPaid = schedule.reduce((sum, payment) => sum + payment.amount, 0);
                const difference = totalPV - this.cashValue;
                const percentDiff = (difference / this.cashValue) * 100;
                
                return {
                    totalPV,
                    totalPaid,
                    cashValue: this.cashValue,
                    difference,
                    percentDiff,
                    status: Math.abs(difference) < 1000 ? 'Ù…Ø·Ø§Ø¨Ù‚ âœ…' : 'ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ âŒ',
                    accuracy: Math.abs(percentDiff) < 0.1 ? 'Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©' : 'ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„'
                };
            }

            calculateSummary(schedule) {
                const totalPaid = schedule.reduce((sum, p) => sum + p.amount, 0);
                const totalPV = schedule.reduce((sum, p) => sum + p.pv, 0);
                const totalDiscount = schedule.reduce((sum, p) => sum + p.discount, 0);
                
                return {
                    numberOfPayments: schedule.length,
                    totalPaid,
                    totalPV,
                    totalDiscount,
                    effectiveInterestRate: ((totalPaid - this.cashValue) / this.cashValue) * 100,
                    averagePayment: totalPaid / schedule.length
                };
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BETA SMART FINANCE - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø³ÙŠØ· Ø§Ù„Ù…Ø±Ù†
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function BetaSmartFinance() {
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const ADMIN_PASSWORD = 'beta2025';

            const [projects, setProjects] = useState(() => {
                const saved = localStorage.getItem('betaProjects_v2_9');
                return saved ? JSON.parse(saved) : [
                   
                    { 
                        id: 3, 
                        name: 'Ø¨ÙŠØªØ§ Ø±ÙŠØ²ÙŠØ¯Ù†Ø³ Ø£ÙƒØªÙˆØ¨Ø±', 
                        cashDiscountRate: 30, 
                        discountRate: 14.00,
                        discountRateMode: 'manual',
                        minDownPaymentPercent: 5,
                        baseSystem: {
                            downPaymentValue: 15,
                            downPaymentIsPercentage: true,
                            downPaymentDate: null,
                            annualPayments: [{ value: 10, isPercentage: true, type: 'Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ©', date: null }],
                            semiannualPayments: [],
                            quarterlyPayments: [],
                            quarterlyYears: 8
                        },
                        description: 'Ù…Ø¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ ÙØ§Ø®Ø±', 
                        color: 'purple' 
                    },
                    { 
                        id: 4, 
                        name: 'Ø¨ÙŠØªØ§ Ø¬Ø±ÙŠÙ†Ø² - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø³ÙŠØªÙ‰', 
                        cashDiscountRate: 2.583, 
                        discountRate: 24.000,
                        discountRateMode: 'manual',
                        minDownPaymentPercent: 25,
                        baseSystem: {
                            downPaymentValue: 50,
                            downPaymentIsPercentage: true,
                            downPaymentDate: null,
                            annualPayments: [],
                            semiannualPayments: [],
                            quarterlyPayments: [],
                            quarterlyYears: 0.2451
                        },
                        description: 'ğŸ¯ Ø§Ø³ØªÙ„Ø§Ù… ÙÙˆØ±Ù‰: 50% Ù…Ù‚Ø¯Ù… Ùˆ50% Ø¨Ø¹Ø¯ 3 Ø´Ù‡ÙˆØ± | Ù…Ø´Ø±ÙˆØ¹ Ù…ØªÙ…ÙŠØ² ÙÙŠ Ù…Ø³ØªÙ‚Ø¨Ù„ Ø³ÙŠØªÙ‰', 
                        color: 'rose' 
                    },
                ];
            });

            useEffect(() => {
                localStorage.setItem('betaProjects_v2_9', JSON.stringify(projects));
            }, [projects]);

            const [showProjectsManager, setShowProjectsManager] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [selectedProjectId, setSelectedProjectId] = useState(1);
            
            const [showBaseSystemModal, setShowBaseSystemModal] = useState(false);
            const [currentProjectForBaseSystem, setCurrentProjectForBaseSystem] = useState(null);
            const [tempBaseSystem, setTempBaseSystem] = useState({
                downPaymentValue: 10,
                downPaymentIsPercentage: true,
                annualPayments: [],
                semiannualPayments: [],
                quarterlyPayments: [],
                quarterlyYears: 8,
                startDate: ''
            });
            
            const [unitValue, setUnitValue] = useState(10000000);
            const [unitArea, setUnitArea] = useState(0);
            const [unitNumber, setUnitNumber] = useState('');
            const [selectedPattern, setSelectedPattern] = useState('equal');
            
            const [downPaymentValue, setDownPaymentValue] = useState(10);
            const [downPaymentIsPercentage, setDownPaymentIsPercentage] = useState(true);
            const [numberOfYears, setNumberOfYears] = useState(8);
            const [frequency, setFrequency] = useState(4);
            const [annualPayments, setAnnualPayments] = useState([]);
            const [semiannualPayments, setSemiannualPayments] = useState([]);
            const [quarterlyPayments, setQuarterlyPayments] = useState([]);
            const [quarterlyStartDate, setQuarterlyStartDate] = useState('');
            
            const [decreaseRate, setDecreaseRate] = useState(2);
            const [growthRate, setGrowthRate] = useState(3);
            
            // Ø®ÙŠØ§Ø± ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚Ø³Ø·
            const [roundingOption, setRoundingOption] = useState('none'); // 'none', '500', '1000'
            
            // Ø®ÙŠØ§Ø± ÙŠÙˆÙ… Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø³Ø· (1 Ø£Ùˆ 15)
            const [installmentDay, setInstallmentDay] = useState(1); // 1 or 15
            
            const [customPayments, setCustomPayments] = useState([]);
            const [quarterlyYears, setQuarterlyYears] = useState(8);
            const [customQuarterlyStartDate, setCustomQuarterlyStartDate] = useState('');
            
            const [results, setResults] = useState(null);
            const [baseSystemResults, setBaseSystemResults] = useState(null);
            const [showComparison, setShowComparison] = useState(false);
            const [comparisonView, setComparisonView] = useState('summary');

            const patterns = [
                { id: 'equal', name: 'Ù‚Ø³Ø· Ù…ÙˆØ­Ø¯', description: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¨Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ…Ø©', color: 'blue', icon: 'âš–ï¸' },
                { id: 'decreasing', name: 'Ø£Ù‚Ø³Ø§Ø· Ù…ØªÙ†Ø§Ù‚ØµØ©', description: 'Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ØªØªÙ†Ø§Ù‚Øµ Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª', color: 'emerald', icon: 'ğŸ“‰' },
                { id: 'graduated', name: 'Ø£Ù‚Ø³Ø§Ø· Ù…ØªØ²Ø§ÙŠØ¯Ø©', description: 'Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ØªØ²ÙŠØ¯ Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª', color: 'purple', icon: 'ğŸ“ˆ' },
                { id: 'custom', name: 'ØªÙˆØ²ÙŠØ¹ Ù…Ø®ØµØµ', description: 'Ø£Ù†Øª ØªØ­Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª', color: 'amber', icon: 'âš¡' },
            ];

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('ar-EG', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value) + ' Ø¬';
            };

            const formatDate = (dateString) => {
                return new Date(dateString).toLocaleDateString('ar-EG', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            };

            // Ø¯Ø§Ù„Ø© ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚Ø³Ø· Ù„Ù„Ø£Ø¹Ù„Ù‰ (Ù„Ø£Ù‚Ø±Ø¨ ØµÙØ±ÙŠÙ† = 100)
            const roundInstallmentUp = (amount, roundTo = 100) => {
                return Math.ceil(amount / roundTo) * roundTo;
            };

            // Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª (Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø£Ù‚Ø±Ø¨ 100)
            const applyAutoRoundingToSchedule = (schedule) => {
                return schedule.map(payment => {
                    // Ù„Ø§ Ù†Ù‚Ø±Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (Ø§Ù„Ø³Ù†ÙˆÙŠØ©/Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©/Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©)
                    if (payment.type === 'Ù…Ù‚Ø¯Ù…' || 
                        payment.type.includes('Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ©') || 
                        payment.type.includes('Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©') ||
                        payment.type.includes('Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©')) {
                        return payment;
                    }
                    
                    // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø£Ù‚Ø±Ø¨ 100
                    const roundedAmount = roundInstallmentUp(payment.amount, 100);
                    return {
                        ...payment,
                        amount: roundedAmount,
                        discount: roundedAmount - payment.pv
                    };
                });
            };

            // Ø¯Ø§Ù„Ø© ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚Ø³Ø· (Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©)
            const roundInstallment = (amount, option) => {
                if (option === 'none' || !option) return amount;
                const roundTo = parseInt(option);
                // Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø¯Ø§Ø¦Ù…Ø§Ù‹
                return Math.ceil(amount / roundTo) * roundTo;
            };

            // Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª (Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©)
            const applyRoundingToSchedule = (schedule, roundingOpt) => {
                if (roundingOpt === 'none' || !roundingOpt) return schedule;
                
                return schedule.map(payment => {
                    // Ù„Ø§ Ù†Ù‚Ø±Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (Ø§Ù„Ø³Ù†ÙˆÙŠØ©/Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©/Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©)
                    if (payment.type === 'Ù…Ù‚Ø¯Ù…' || 
                        payment.type.includes('Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ©') || 
                        payment.type.includes('Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©') ||
                        payment.type.includes('Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©')) {
                        return payment;
                    }
                    
                    // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù„Ù„Ø£Ø¹Ù„Ù‰
                    const roundedAmount = roundInstallment(payment.amount, roundingOpt);
                    return {
                        ...payment,
                        amount: roundedAmount,
                        discount: roundedAmount - payment.pv
                    };
                });
            };

            const getSelectedProject = () => projects.find(p => p.id === selectedProjectId);

            const handlePrint = () => {
                window.print();
            };

            // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¥Ù„Ù‰ PDF (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
            const exportComparisonToPDF = () => {
                const element = document.getElementById('comparison-content');
                if (!element) {
                    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØµØ¯ÙŠØ±');
                    return;
                }

                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `ØªØ­Ù„ÙŠÙ„_Ù…Ù‚Ø§Ø±Ù†_${getSelectedProject()?.name || 'Ù…Ø´Ø±ÙˆØ¹'}_${new Date().toLocaleDateString('ar-EG').replace(/\//g, '-')}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true,
                        letterRendering: true,
                        scrollY: 0
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
                const loadingMsg = document.createElement('div');
                loadingMsg.id = 'pdf-loading';
                loadingMsg.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;"><div style="background:white;padding:30px;border-radius:10px;text-align:center;"><p style="font-size:18px;margin:0;">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF...</p><p style="font-size:14px;color:#666;margin-top:10px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p></div></div>';
                document.body.appendChild(loadingMsg);

                html2pdf().set(opt).from(element).save().then(() => {
                    document.body.removeChild(loadingMsg);
                }).catch((err) => {
                    document.body.removeChild(loadingMsg);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ PDF');
                    console.error(err);
                });
            };

            const calculateDownPayment = () => {
                return downPaymentIsPercentage 
                    ? unitValue * (downPaymentValue / 100)
                    : downPaymentValue;
            };

            useEffect(() => {
                const project = getSelectedProject();
                if (project && project.baseSystem && unitValue > 0) {
                    if (selectedPattern === 'equal' || selectedPattern === 'decreasing' || selectedPattern === 'graduated') {
                        setDownPaymentValue(project.baseSystem.downPaymentValue);
                        setDownPaymentIsPercentage(project.baseSystem.downPaymentIsPercentage);
                        setNumberOfYears(project.baseSystem.quarterlyYears);
                        
                        if (project.baseSystem.annualPayments && project.baseSystem.annualPayments.length > 0) {
                            const today = new Date();
                            const formattedPayments = project.baseSystem.annualPayments.map((p, index) => {
                                const paymentDate = new Date(today);
                                paymentDate.setFullYear(today.getFullYear() + index + 1);
                                return {
                                    id: Date.now() + index,
                                    type: p.type || 'Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ©',
                                    value: p.value,
                                    isPercentage: p.isPercentage,
                                    date: paymentDate.toISOString().split('T')[0]
                                };
                            });
                            setAnnualPayments(formattedPayments);
                        } else {
                            setAnnualPayments([]);
                        }

                        if (project.baseSystem.semiannualPayments && project.baseSystem.semiannualPayments.length > 0) {
                            const today = new Date();
                            const formattedPayments = project.baseSystem.semiannualPayments.map((p, index) => {
                                const paymentDate = new Date(today);
                                paymentDate.setMonth(today.getMonth() + (index + 1) * 6);
                                return {
                                    id: Date.now() + index + 1000,
                                    type: p.type || 'Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©',
                                    value: p.value,
                                    isPercentage: p.isPercentage,
                                    date: paymentDate.toISOString().split('T')[0]
                                };
                            });
                            setSemiannualPayments(formattedPayments);
                        } else {
                            setSemiannualPayments([]);
                        }

                        if (project.baseSystem.quarterlyPayments && project.baseSystem.quarterlyPayments.length > 0) {
                            const today = new Date();
                            const formattedPayments = project.baseSystem.quarterlyPayments.map((p, index) => {
                                const paymentDate = new Date(today);
                                paymentDate.setMonth(today.getMonth() + (index + 1) * 3);
                                return {
                                    id: Date.now() + index + 2000,
                                    type: p.type || 'Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©',
                                    value: p.value,
                                    isPercentage: p.isPercentage,
                                    date: paymentDate.toISOString().split('T')[0]
                                };
                            });
                            setQuarterlyPayments(formattedPayments);
                        } else {
                            setQuarterlyPayments([]);
                        }
                    }
                }
            }, [selectedProjectId, selectedPattern, unitValue]);

            const openBaseSystemModal = (projectId) => {
                const project = projects.find(p => p.id === projectId);
                setCurrentProjectForBaseSystem(project);
                
                if (project.baseSystem) {
                    setTempBaseSystem({
                        ...project.baseSystem,
                        quarterlyPayments: project.baseSystem.quarterlyPayments || [],
                        startDate: project.baseSystem.startDate || ''
                    });
                } else {
                    setTempBaseSystem({
                        downPaymentValue: 10,
                        downPaymentIsPercentage: true,
                        annualPayments: [],
                        semiannualPayments: [],
                        quarterlyPayments: [],
                        quarterlyYears: 8,
                        startDate: ''
                    });
                }
                
                setShowBaseSystemModal(true);
            };

            const calculateDiscountRateForProject = () => {
                if (!currentProjectForBaseSystem) return;
                
                if (!unitValue || unitValue <= 0) {
                    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }

                const engine = new SmartPaymentEngine(
                    unitValue, 
                    currentProjectForBaseSystem.cashDiscountRate, 
                    14,
                    new Date()
                );
                
                const impliedRate = engine.calculateImpliedDiscountRate(tempBaseSystem, unitValue);
                
                const updatedProjects = projects.map(p => {
                    if (p.id === currentProjectForBaseSystem.id) {
                        return {
                            ...p,
                            discountRate: impliedRate,
                            discountRateMode: 'auto',
                            baseSystem: tempBaseSystem
                        };
                    }
                    return p;
                });
                
                setProjects(updatedProjects);
                setShowBaseSystemModal(false);
                
                alert(`âœ… ØªÙ… Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ… Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ "${currentProjectForBaseSystem.name}"!\n\nÙ…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø­Ø³ÙˆØ¨: ${impliedRate.toFixed(3)}%\n\nØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.`);
            };

            const addProject = () => {
                const newProject = {
                    id: Date.now(),
                    name: 'Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯',
                    cashDiscountRate: 30,
                    discountRate: 14.643,
                    discountRateMode: 'manual',
                    minDownPaymentPercent: 5,
                    baseSystem: {
                        downPaymentValue: 10,
                        downPaymentIsPercentage: true,
                        annualPayments: [],
                        semiannualPayments: [],
                        quarterlyYears: 8
                    },
                    description: 'ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
                    color: 'indigo'
                };
                setProjects([...projects, newProject]);
                setEditingProject(newProject.id);
            };

            const deleteProject = (projectId) => {
                if (projects.length === 1) {
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ù…Ø´Ø±ÙˆØ¹!');
                    return;
                }
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ')) {
                    setProjects(projects.filter(p => p.id !== projectId));
                    if (selectedProjectId === projectId) {
                        setSelectedProjectId(projects.find(p => p.id !== projectId).id);
                    }
                }
            };

            const updateProject = (projectId, field, value) => {
                setProjects(projects.map(p => 
                    p.id === projectId ? { ...p, [field]: value } : p
                ));
            };

            const addAnnualPayment = () => {
                const today = new Date();
                const defaultDate = new Date(today);
                defaultDate.setFullYear(today.getFullYear() + 1);
                
                setAnnualPayments([...annualPayments, {
                    id: Date.now(),
                    type: 'Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ©',
                    value: 10,
                    isPercentage: true,
                    date: defaultDate.toISOString().split('T')[0]
                }]);
            };

            const updateAnnualPayment = (id, field, value) => {
                setAnnualPayments(annualPayments.map(p =>
                    p.id === id ? { ...p, [field]: value } : p
                ));
            };

            const deleteAnnualPayment = (id) => {
                setAnnualPayments(annualPayments.filter(p => p.id !== id));
            };

            const addSemiannualPayment = () => {
                const today = new Date();
                const defaultDate = new Date(today);
                defaultDate.setMonth(today.getMonth() + 6);
                
                setSemiannualPayments([...semiannualPayments, {
                    id: Date.now(),
                    type: 'Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©',
                    value: 5,
                    isPercentage: true,
                    date: defaultDate.toISOString().split('T')[0]
                }]);
            };

            const updateSemiannualPayment = (id, field, value) => {
                setSemiannualPayments(semiannualPayments.map(p =>
                    p.id === id ? { ...p, [field]: value } : p
                ));
            };

            const deleteSemiannualPayment = (id) => {
                setSemiannualPayments(semiannualPayments.filter(p => p.id !== id));
            };

            const addQuarterlyPayment = () => {
                const today = new Date();
                const defaultDate = new Date(today);
                defaultDate.setMonth(today.getMonth() + 3);
                
                setQuarterlyPayments([...quarterlyPayments, {
                    id: Date.now(),
                    type: 'Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©',
                    value: 5,
                    isPercentage: true,
                    date: defaultDate.toISOString().split('T')[0]
                }]);
            };

            const updateQuarterlyPayment = (id, field, value) => {
                setQuarterlyPayments(quarterlyPayments.map(p =>
                    p.id === id ? { ...p, [field]: value } : p
                ));
            };

            const deleteQuarterlyPayment = (id) => {
                setQuarterlyPayments(quarterlyPayments.filter(p => p.id !== id));
            };

            const addCustomPayment = () => {
                const today = new Date();
                const defaultDate = new Date(today);
                defaultDate.setFullYear(today.getFullYear() + 1);
                
                setCustomPayments([...customPayments, {
                    id: Date.now(),
                    type: 'Ø¯ÙØ¹Ø© Ù…Ø®ØµØµØ©',
                    value: 100000,
                    isPercentage: false,
                    frequency: 'once',
                    numberOfPayments: 1,
                    startDate: defaultDate.toISOString().split('T')[0]
                }]);
            };

            const updateCustomPayment = (id, field, value) => {
                setCustomPayments(customPayments.map(p =>
                    p.id === id ? { ...p, [field]: value } : p
                ));
            };

            const deleteCustomPayment = (id) => {
                setCustomPayments(customPayments.filter(p => p.id !== id));
            };

            const calculateResults = () => {
                const project = getSelectedProject();
                if (!project) {
                    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø´Ø±ÙˆØ¹');
                    return;
                }

                if (!unitValue || unitValue <= 0) {
                    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆØ­Ø¯Ø©');
                    return;
                }

                if (numberOfYears <= 0) {
                    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙˆØ§Øª');
                    return;
                }

                const engine = new SmartPaymentEngine(
                    unitValue, 
                    project.cashDiscountRate, 
                    project.discountRate,
                    new Date()
                );
                
                let result = null;
                const downPayment = calculateDownPayment();

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù‚Ø¯Ù… Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹
                const minDownPaymentPercent = project.minDownPaymentPercent || 5;
                const minDownPayment = unitValue * (minDownPaymentPercent / 100);
                const actualDownPaymentPercent = (downPayment / unitValue) * 100;
                
                if (downPayment < minDownPayment) {
                    alert(`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¨Ø§Ø¦Ø¹:\n\nÙ‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙ‚Ù„ Ø¹Ù† ${minDownPaymentPercent}% Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù…Ø´Ø±ÙˆØ¹ "${project.name}".\n\nØ§Ù„Ù…Ù‚Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${actualDownPaymentPercent.toFixed(2)}%\nØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${minDownPaymentPercent}%\nÙ‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: ${formatCurrency(minDownPayment)}\n\nÙŠØ±Ø¬Ù‰ Ø²ÙŠØ§Ø¯Ø© Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù….`);
                    return;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù‚Ø¯Ù… Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒØ§Ø´
                const cashValue = unitValue * (1 - project.cashDiscountRate / 100);
                if (downPayment >= cashValue) {
                    alert('âš ï¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù… ØªØªØ¬Ø§ÙˆØ² Ø£Ùˆ ØªØ³Ø§ÙˆÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©');
                    return;
                }

                const annualPaymentsProcessed = annualPayments.map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date
                }));

                const semiannualPaymentsProcessed = semiannualPayments.map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date
                }));

                const quarterlyPaymentsProcessed = quarterlyPayments.map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date
                }));

                const commonParams = {
                    downPayment,
                    numberOfYears,
                    frequency,
                    annualPayments: annualPaymentsProcessed,
                    semiannualPayments: semiannualPaymentsProcessed,
                    quarterlyPayments: quarterlyPaymentsProcessed,
                    quarterlyStartDate: quarterlyStartDate || null,
                    installmentDay: installmentDay // ÙŠÙˆÙ… Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø³Ø·
                };

                try {
                    switch (selectedPattern) {
                        case 'equal':
                            result = engine.calculateEqualInstallments(commonParams);
                            break;
                        case 'decreasing':
                            result = engine.calculateDecreasingPayments({
                                ...commonParams,
                                decreaseRate
                            });
                            break;
                        case 'graduated':
                            result = engine.calculateGraduatedPayments({
                                ...commonParams,
                                growthRate
                            });
                            break;
                        case 'custom':
                            const customPaymentsProcessed = customPayments.map(p => ({
                                type: p.type,
                                amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                                frequency: p.frequency,
                                numberOfPayments: p.numberOfPayments,
                                startDate: p.startDate
                            }));
                            
                            result = engine.calculateCustomDistribution({
                                downPayment,
                                customPayments: customPaymentsProcessed,
                                quarterlyYears,
                                quarterlyStartDate: customQuarterlyStartDate || null,
                                installmentDay: installmentDay
                            });
                            break;
                    }

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    if (result && result.schedule && result.schedule.some(p => isNaN(p.amount) || p.amount < 0)) {
                        alert('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.');
                        return;
                    }

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø£Ù‚Ø±Ø¨ 100 Ø£ÙˆÙ„Ø§Ù‹
                    if (result) {
                        result.schedule = applyAutoRoundingToSchedule(result.schedule);
                        result.autoRounded = true;
                    }

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ (500 Ø£Ùˆ 1000)
                    if (roundingOption !== 'none' && result) {
                        result.schedule = applyRoundingToSchedule(result.schedule, roundingOption);
                        result.roundingApplied = roundingOption;
                    }

                    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨
                    if (result) {
                        result.summary = {
                            ...result.summary,
                            totalPaid: result.schedule.reduce((sum, p) => sum + p.amount, 0),
                            averagePayment: result.schedule.reduce((sum, p) => sum + p.amount, 0) / result.schedule.length
                        };
                    }

                    setResults(result);

                    if (project.baseSystem) {
                        const baseEngine = new SmartPaymentEngine(
                            unitValue, 
                            project.cashDiscountRate, 
                            project.discountRate,
                            new Date()
                        );
                        const baseResult = baseEngine.calculateBaseSystem(project.baseSystem, unitValue);
                        setBaseSystemResults(baseResult);
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:', error);
                    alert('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message);
                }
            };

            const handleAdminLogin = () => {
                if (adminPassword === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    setShowAdminPanel(false);
                    setAdminPassword('');
                } else {
                    alert('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
                }
            };

            useEffect(() => {
                if (!quarterlyStartDate) {
                    const today = new Date();
                    const defaultDate = new Date(today);
                    defaultDate.setMonth(today.getMonth() + 3);
                    setQuarterlyStartDate(defaultDate.toISOString().split('T')[0]);
                }
                if (!customQuarterlyStartDate) {
                    const today = new Date();
                    const defaultDate = new Date(today);
                    defaultDate.setMonth(today.getMonth() + 3);
                    setCustomQuarterlyStartDate(defaultDate.toISOString().split('T')[0]);
                }
            }, []);

            // Enhanced Comparison Component
            const ComparisonModal = () => {
                if (!showComparison || !baseSystemResults || !results) return null;

                const maxLength = Math.max(baseSystemResults.schedule.length, results.schedule.length);
                
                return (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden" onClick={() => setShowComparison(false)}>
                        <div className="bg-white rounded-2xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto animate-fade-in" onClick={(e) => e.stopPropagation()}>
                            <div className="bg-gradient-to-r from-gray-900 to-black px-8 py-6 text-white sticky top-0 rounded-t-2xl z-10">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="text-3xl font-bold">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ù…Ù‚Ø§Ø±Ù† Ù…ØªÙ‚Ø¯Ù…</h2>
                                        <p className="text-sm text-blue-100 mt-1">Ù…Ù‚Ø§Ø±Ù†Ø© Ø´Ø§Ù…Ù„Ø© Ø¨ÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
                                    </div>
                                    <div className="flex gap-2">
                                        {isAdmin && (
                                            <button 
                                                onClick={exportComparisonToPDF} 
                                                className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center gap-2"
                                            >
                                                ğŸ“„ ØªØµØ¯ÙŠØ± PDF
                                            </button>
                                        )}
                                        <button onClick={() => setShowComparison(false)} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button>
                                    </div>
                                </div>
                                
                                <div className="flex gap-2 mt-4">
                                    <button
                                        onClick={() => setComparisonView('summary')}
                                        className={`px-4 py-2 rounded-lg transition-all ${comparisonView === 'summary' ? 'bg-white text-red-600' : 'bg-white/20'}`}
                                    >
                                        ğŸ“ˆ Ù…Ù„Ø®Øµ
                                    </button>
                                    <button
                                        onClick={() => setComparisonView('detailed')}
                                        className={`px-4 py-2 rounded-lg transition-all ${comparisonView === 'detailed' ? 'bg-white text-red-600' : 'bg-white/20'}`}
                                    >
                                        ğŸ” ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ
                                    </button>
                                    <button
                                        onClick={() => setComparisonView('schedule')}
                                        className={`px-4 py-2 rounded-lg transition-all ${comparisonView === 'schedule' ? 'bg-white text-red-600' : 'bg-white/20'}`}
                                    >
                                        ğŸ“‹ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                                    </button>
                                </div>
                            </div>
                            
                            <div id="comparison-content" className="p-8">
                                {comparisonView === 'summary' && (
                                    <div className="space-y-6">
                                        {/* Ø¹Ù†ÙˆØ§Ù† Ù„Ù„ØªØµØ¯ÙŠØ± PDF */}
                                        <div className="text-center mb-6 hidden" id="pdf-header">
                                            <h1 className="text-2xl font-bold text-red-600">Ø´Ø±ÙƒØ© Ø¨ÙŠØªØ§ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</h1>
                                            <p className="text-lg">ØªØ­Ù„ÙŠÙ„ Ù…Ù‚Ø§Ø±Ù† - {getSelectedProject()?.name}</p>
                                            <p className="text-sm text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®: {new Date().toLocaleDateString('ar-EG')}</p>
                                        </div>
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div className="bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl p-6 border-2 border-gray-300">
                                                <h3 className="text-2xl font-bold mb-4 text-blue-700 flex items-center gap-2">
                                                    <span>ğŸ“˜</span> Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                                                </h3>
                                                <div className="space-y-3">
                                                    <div className="bg-white rounded-lg p-4">
                                                        <p className="text-sm text-gray-600">Ø§Ù„Ù…Ù‚Ø¯Ù…</p>
                                                        <p className="text-xl font-bold">{formatCurrency(baseSystemResults.downPayment)}</p>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-4">
                                                        <p className="text-sm text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</p>
                                                        <p className="text-xl font-bold">{baseSystemResults.schedule.length - 1}</p>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-4">
                                                        <p className="text-sm text-gray-600">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯ÙØ¹Ø©</p>
                                                        <p className="text-xl font-bold">{formatCurrency(baseSystemResults.summary.averagePayment)}</p>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-4">
                                                        <p className="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
                                                        <p className="text-2xl font-bold text-blue-600">{formatCurrency(baseSystemResults.summary.totalPaid)}</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-200">
                                                <h3 className="text-2xl font-bold mb-4 text-green-700 flex items-center gap-2">
                                                    <span>ğŸ“—</span> Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                                                </h3>
                                                <div className="space-y-3">
                                                    <div className="bg-white rounded-lg p-4">
                                                        <p className="text-sm text-gray-600">Ø§Ù„Ù…Ù‚Ø¯Ù…</p>
                                                        <p className="text-xl font-bold">{formatCurrency(results.downPayment)}</p>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-4">
                                                        <p className="text-sm text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</p>
                                                        <p className="text-xl font-bold">{results.schedule.length - 1}</p>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-4">
                                                        <p className="text-sm text-gray-600">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯ÙØ¹Ø©</p>
                                                        <p className="text-xl font-bold">{formatCurrency(results.summary.averagePayment)}</p>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-4">
                                                        <p className="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
                                                        <p className="text-2xl font-bold text-green-600">{formatCurrency(results.summary.totalPaid)}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl p-6 border-2 border-yellow-200">
                                            <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
                                                <span>ğŸ“Š</span> Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„
                                            </h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div className="bg-white rounded-lg p-4">
                                                    <p className="text-sm text-gray-600 mb-1">ÙØ±Ù‚ Ø§Ù„Ù…Ù‚Ø¯Ù…</p>
                                                    <p className={`text-xl font-bold ${results.downPayment > baseSystemResults.downPayment ? 'text-green-600' : 'text-red-600'}`}>
                                                        {formatCurrency(Math.abs(results.downPayment - baseSystemResults.downPayment))}
                                                    </p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        {results.downPayment > baseSystemResults.downPayment ? 'â†‘ Ø£Ø¹Ù„Ù‰' : 'â†“ Ø£Ù‚Ù„'}
                                                    </p>
                                                </div>
                                                <div className="bg-white rounded-lg p-4">
                                                    <p className="text-sm text-gray-600 mb-1">ÙØ±Ù‚ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</p>
                                                    <p className={`text-xl font-bold ${(results.schedule.length - 1) < (baseSystemResults.schedule.length - 1) ? 'text-green-600' : 'text-red-600'}`}>
                                                        {Math.abs((results.schedule.length - 1) - (baseSystemResults.schedule.length - 1))}
                                                    </p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        {(results.schedule.length - 1) < (baseSystemResults.schedule.length - 1) ? 'Ø£Ù‚Ù„ Ø¯ÙØ¹Ø§Øª' : 'Ø£ÙƒØ«Ø± Ø¯ÙØ¹Ø§Øª'}
                                                    </p>
                                                </div>
                                                <div className="bg-white rounded-lg p-4">
                                                    <p className="text-sm text-gray-600 mb-1">ÙØ±Ù‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>
                                                    <p className={`text-xl font-bold ${results.summary.totalPaid < baseSystemResults.summary.totalPaid ? 'text-green-600' : 'text-red-600'}`}>
                                                        {formatCurrency(Math.abs(results.summary.totalPaid - baseSystemResults.summary.totalPaid))}
                                                    </p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        {results.summary.totalPaid < baseSystemResults.summary.totalPaid ? 'â†“ ØªÙˆÙÙŠØ±' : 'â†‘ Ø²ÙŠØ§Ø¯Ø©'}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {comparisonView === 'detailed' && (
                                    <div className="space-y-6">
                                        <div className="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl p-6 border-2 border-gray-300">
                                            <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
                                                <span>ğŸ’°</span> Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
                                            </h3>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm comparison-table">
                                                    <thead className="bg-gray-200">
                                                        <tr>
                                                            <th className="px-4 py-3 text-right font-bold">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                                                            <th className="px-4 py-3 text-center font-bold">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                                                            <th className="px-4 py-3 text-center font-bold">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
                                                            <th className="px-4 py-3 text-center font-bold">Ø§Ù„ÙØ±Ù‚</th>
                                                            <th className="px-4 py-3 text-center font-bold">Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td className="font-bold">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆØ­Ø¯Ø©</td>
                                                            <td className="text-center">{formatCurrency(unitValue)}</td>
                                                            <td className="text-center">{formatCurrency(unitValue)}</td>
                                                            <td className="text-center">-</td>
                                                            <td className="text-center">-</td>
                                                        </tr>
                                                        <tr>
                                                            <td className="font-bold">Ø§Ù„Ù…Ù‚Ø¯Ù…</td>
                                                            <td className="text-center">{formatCurrency(baseSystemResults.downPayment)}</td>
                                                            <td className="text-center">{formatCurrency(results.downPayment)}</td>
                                                            <td className={`text-center ${results.downPayment > baseSystemResults.downPayment ? 'comparison-highlight-negative' : 'comparison-highlight-positive'}`}>
                                                                {formatCurrency(results.downPayment - baseSystemResults.downPayment)}
                                                            </td>
                                                            <td className="text-center">
                                                                {((results.downPayment - baseSystemResults.downPayment) / baseSystemResults.downPayment * 100).toFixed(2)}%
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td className="font-bold">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</td>
                                                            <td className="text-center">{baseSystemResults.schedule.length - 1}</td>
                                                            <td className="text-center">{results.schedule.length - 1}</td>
                                                            <td className={`text-center ${(results.schedule.length - 1) > (baseSystemResults.schedule.length - 1) ? 'comparison-highlight-negative' : 'comparison-highlight-positive'}`}>
                                                                {(results.schedule.length - 1) - (baseSystemResults.schedule.length - 1)}
                                                            </td>
                                                            <td className="text-center">
                                                                {(((results.schedule.length - 1) - (baseSystemResults.schedule.length - 1)) / (baseSystemResults.schedule.length - 1) * 100).toFixed(2)}%
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td className="font-bold">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯ÙØ¹Ø©</td>
                                                            <td className="text-center">{formatCurrency(baseSystemResults.summary.averagePayment)}</td>
                                                            <td className="text-center">{formatCurrency(results.summary.averagePayment)}</td>
                                                            <td className={`text-center ${results.summary.averagePayment > baseSystemResults.summary.averagePayment ? 'comparison-highlight-negative' : 'comparison-highlight-positive'}`}>
                                                                {formatCurrency(results.summary.averagePayment - baseSystemResults.summary.averagePayment)}
                                                            </td>
                                                            <td className="text-center">
                                                                {((results.summary.averagePayment - baseSystemResults.summary.averagePayment) / baseSystemResults.summary.averagePayment * 100).toFixed(2)}%
                                                            </td>
                                                        </tr>
                                                        <tr className="bg-yellow-50">
                                                            <td className="font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td>
                                                            <td className="text-center font-bold">{formatCurrency(baseSystemResults.summary.totalPaid)}</td>
                                                            <td className="text-center font-bold">{formatCurrency(results.summary.totalPaid)}</td>
                                                            <td className={`text-center ${results.summary.totalPaid > baseSystemResults.summary.totalPaid ? 'comparison-highlight-negative' : 'comparison-highlight-positive'}`}>
                                                                {formatCurrency(results.summary.totalPaid - baseSystemResults.summary.totalPaid)}
                                                            </td>
                                                            <td className="text-center font-bold">
                                                                {((results.summary.totalPaid - baseSystemResults.summary.totalPaid) / baseSystemResults.summary.totalPaid * 100).toFixed(2)}%
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        {isAdmin && (
                                            <div className="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl p-6 border-2 border-gray-300">
                                                <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
                                                    <span>ğŸ“‰</span> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Ù„Ù„Ù…Ø¯ÙŠØ±)
                                                </h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div className="bg-white rounded-lg p-4">
                                                        <h4 className="font-bold text-lg mb-3 text-blue-600">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</h4>
                                                        <div className="space-y-2 text-sm">
                                                            <div className="flex justify-between">
                                                                <span>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„ØµØ§ÙÙŠØ©:</span>
                                                                <span className="font-bold">{formatCurrency(baseSystemResults.verification.totalPV)}</span>
                                                            </div>
                                                            <div className="flex justify-between">
                                                                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª:</span>
                                                                <span className="font-bold">{formatCurrency(baseSystemResults.summary.totalDiscount)}</span>
                                                            </div>
                                                            <div className="flex justify-between">
                                                                <span>Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©:</span>
                                                                <span className="font-bold">{baseSystemResults.summary.effectiveInterestRate.toFixed(2)}%</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-4">
                                                        <h4 className="font-bold text-lg mb-3 text-green-600">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</h4>
                                                        <div className="space-y-2 text-sm">
                                                            <div className="flex justify-between">
                                                                <span>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„ØµØ§ÙÙŠØ©:</span>
                                                                <span className="font-bold">{formatCurrency(results.verification.totalPV)}</span>
                                                            </div>
                                                            <div className="flex justify-between">
                                                                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª:</span>
                                                                <span className="font-bold">{formatCurrency(results.summary.totalDiscount)}</span>
                                                            </div>
                                                            <div className="flex justify-between">
                                                                <span>Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©:</span>
                                                                <span className="font-bold">{results.summary.effectiveInterestRate.toFixed(2)}%</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {comparisonView === 'schedule' && (
                                    <div className="space-y-6">
                                        <div className="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl p-6 border-2 border-gray-300">
                                            <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
                                                <span>ğŸ“…</span> Ù…Ù‚Ø§Ø±Ù†Ø© Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª
                                            </h3>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm comparison-table">
                                                    <thead className="bg-gray-200">
                                                        <tr>
                                                            <th className="px-4 py-3 text-center font-bold">Ù…</th>
                                                            <th className="px-4 py-3 text-right font-bold">Ø§Ù„Ù†ÙˆØ¹ (Ø£Ø³Ø§Ø³ÙŠ)</th>
                                                            <th className="px-4 py-3 text-center font-bold">Ø§Ù„Ù…Ø¨Ù„Øº (Ø£Ø³Ø§Ø³ÙŠ)</th>
                                                            <th className="px-4 py-3 text-right font-bold">Ø§Ù„Ù†ÙˆØ¹ (Ù…Ø·Ù„ÙˆØ¨)</th>
                                                            <th className="px-4 py-3 text-center font-bold">Ø§Ù„Ù…Ø¨Ù„Øº (Ù…Ø·Ù„ÙˆØ¨)</th>
                                                            <th className="px-4 py-3 text-center font-bold">Ø§Ù„ÙØ±Ù‚</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {Array.from({length: maxLength}).map((_, index) => {
                                                            const basePayment = baseSystemResults.schedule[index];
                                                            const newPayment = results.schedule[index];
                                                            const diff = (basePayment && newPayment) ? newPayment.amount - basePayment.amount : 0;
                                                            
                                                            return (
                                                                <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                                    <td className="text-center font-bold">{index + 1}</td>
                                                                    <td className="text-right">{basePayment ? basePayment.type : '-'}</td>
                                                                    <td className="text-center">{basePayment ? formatCurrency(basePayment.amount) : '-'}</td>
                                                                    <td className="text-right">{newPayment ? newPayment.type : '-'}</td>
                                                                    <td className="text-center">{newPayment ? formatCurrency(newPayment.amount) : '-'}</td>
                                                                    <td className={`text-center ${diff > 0 ? 'text-red-600' : diff < 0 ? 'text-green-600' : ''}`}>
                                                                        {(basePayment && newPayment) ? formatCurrency(Math.abs(diff)) : '-'}
                                                                        {diff > 0 && ' â†‘'}
                                                                        {diff < 0 && ' â†“'}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                        <tr className="bg-yellow-100 font-bold">
                                                            <td colSpan="2" className="text-right">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                                            <td className="text-center">{formatCurrency(baseSystemResults.summary.totalPaid)}</td>
                                                            <td className="text-right">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                                            <td className="text-center">{formatCurrency(results.summary.totalPaid)}</td>
                                                            <td className={`text-center ${results.summary.totalPaid > baseSystemResults.summary.totalPaid ? 'text-red-600' : 'text-green-600'}`}>
                                                                {formatCurrency(Math.abs(results.summary.totalPaid - baseSystemResults.summary.totalPaid))}
                                                                {results.summary.totalPaid > baseSystemResults.summary.totalPaid ? ' â†‘' : ' â†“'}
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-100 via-gray-200 to-gray-100 p-4 md:p-8" dir="rtl">
                    <div className="max-w-7xl mx-auto space-y-6">
                        
                        {/* Header */}
                        <div className="bg-gradient-to-r from-gray-900 via-black to-gray-900 rounded-2xl shadow-2xl p-8 text-white relative overflow-hidden print-hidden border-t-4 border-red-600">
                            <div className="absolute top-0 left-0 w-64 h-64 bg-red-600/10 rounded-full -translate-x-32 -translate-y-32"></div>
                            <div className="absolute bottom-0 right-0 w-96 h-96 bg-red-600/10 rounded-full translate-x-48 translate-y-48"></div>
                            
                            <div className="relative z-10">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h1 className="text-4xl font-bold mb-2">ğŸ¢ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø³ÙŠØ· Ø§Ù„Ù…Ø±Ù†</h1>
                                        <p className="text-gray-300 text-lg">BETA SMART FINANCE | Ø´Ø±ÙƒØ© Ø¨ÙŠØªØ§ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ <span className="text-red-500 font-bold">SINCE 1993</span></p>
                                    </div>
                                    <button
                                        onClick={() => isAdmin ? setIsAdmin(false) : setShowAdminPanel(true)}
                                        className="bg-red-600/80 hover:bg-red-600 px-6 py-3 rounded-xl backdrop-blur-lg transition-all"
                                    >
                                        {isAdmin ? 'ğŸ”“ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±' : 'ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Admin Login */}
                        {showAdminPanel && !isAdmin && (
                            <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-red-200 animate-fade-in print-hidden">
                                <h3 className="text-xl font-bold text-gray-800 mb-4">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
                                <div className="flex gap-4">
                                    <input
                                        type="password"
                                        value={adminPassword}
                                        onChange={(e) => setAdminPassword(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                                        placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                                        className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none"
                                    />
                                    <button onClick={handleAdminLogin} className="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">Ø¯Ø®ÙˆÙ„</button>
                                    <button onClick={() => setShowAdminPanel(false)} className="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
                                </div>
                            </div>
                        )}

                        {/* Projects Selection */}
                        <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100 print-hidden">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-2xl font-bold text-gray-800">ğŸ¢ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
                                {isAdmin && (
                                    <div className="flex gap-2">
                                        <button onClick={addProject} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                            â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹
                                        </button>
                                        <button onClick={() => setShowProjectsManager(!showProjectsManager)} className="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg transition-colors">
                                            âš™ï¸ Ø¥Ø¯Ø§Ø±Ø©
                                        </button>
                                    </div>
                                )}
                            </div>

                            {isAdmin && showProjectsManager && (
                                <div className="mb-6 p-4 bg-gray-50 rounded-lg border-2 border-gray-200 animate-fade-in">
                                    <h3 className="font-bold text-lg mb-4">âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h3>
                                    <div className="space-y-4">
                                        {projects.map(project => (
                                            <div key={project.id} className="bg-white p-4 rounded-lg border border-gray-300">
                                                {editingProject === project.id ? (
                                                    <div className="space-y-3">
                                                        <input
                                                            type="text"
                                                            value={project.name}
                                                            onChange={(e) => updateProject(project.id, 'name', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                                            placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"
                                                        />
                                                        <input
                                                            type="text"
                                                            value={project.description}
                                                            onChange={(e) => updateProject(project.id, 'description', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded"
                                                            placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"
                                                        />
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label className="text-sm font-bold">Ù†Ø³Ø¨Ø© Ø®ØµÙ… Ø§Ù„ÙƒØ§Ø´ (%)</label>
                                                                <input
                                                                    type="number"
                                                                    step="0.01"
                                                                    value={project.cashDiscountRate}
                                                                    onChange={(e) => updateProject(project.id, 'cashDiscountRate', parseFloat(e.target.value))}
                                                                    className="w-full px-3 py-2 border border-gray-300 rounded"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="text-sm font-bold flex items-center gap-2">
                                                                    Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ… (%)
                                                                    {project.discountRateMode === 'auto' && (
                                                                        <span className="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">Ù…Ø­Ø³ÙˆØ¨</span>
                                                                    )}
                                                                </label>
                                                                <input
                                                                    type="number"
                                                                    step="0.001"
                                                                    value={project.discountRate}
                                                                    onChange={(e) => {
                                                                        const newValue = e.target.value;
                                                                        if (newValue === '' || newValue === null) {
                                                                            updateProject(project.id, 'discountRate', 0);
                                                                        } else {
                                                                            const parsedValue = parseFloat(newValue);
                                                                            if (!isNaN(parsedValue)) {
                                                                                updateProject(project.id, 'discountRate', parsedValue);
                                                                                updateProject(project.id, 'discountRateMode', 'manual');
                                                                            }
                                                                        }
                                                                    }}
                                                                    className="w-full px-3 py-2 border border-gray-300 rounded"
                                                                    placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ…"
                                                                />
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label className="text-sm font-bold text-red-600">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ù‚Ø¯Ù… (%)</label>
                                                                <input
                                                                    type="number"
                                                                    step="0.1"
                                                                    min="0"
                                                                    max="100"
                                                                    value={project.minDownPaymentPercent || 5}
                                                                    onChange={(e) => updateProject(project.id, 'minDownPaymentPercent', parseFloat(e.target.value) || 5)}
                                                                    className="w-full px-3 py-2 border border-red-300 rounded bg-red-50"
                                                                    placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ %"
                                                                />
                                                                <p className="text-xs text-gray-500 mt-1">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ø¨Ø§Ø¦Ø¹ ØªØ­Ø¯ÙŠØ¯ Ù…Ù‚Ø¯Ù… Ø£Ù‚Ù„ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø¨Ø©</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => setEditingProject(null)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                                                âœ“ Ø­ÙØ¸
                                                            </button>
                                                            <button onClick={() => openBaseSystemModal(project.id)} className="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded">
                                                                ğŸ§® ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                                                            </button>
                                                            <button onClick={() => deleteProject(project.id)} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                                                                ğŸ—‘ï¸ Ø­Ø°Ù
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex-1">
                                                            <h4 className="font-bold text-lg">{project.name}</h4>
                                                            <p className="text-sm text-gray-600">{project.description}</p>
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                Ø®ØµÙ… ÙƒØ§Ø´: {project.cashDiscountRate}% | Ù…Ø¹Ø¯Ù„ Ø®ØµÙ…: {project.discountRate.toFixed(3)}%
                                                                {project.discountRateMode === 'auto' && <span className="text-green-600"> (Ù…Ø­Ø³ÙˆØ¨)</span>}
                                                                <span className="text-red-600"> | Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ù‚Ø¯Ù…: {project.minDownPaymentPercent || 5}%</span>
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => openBaseSystemModal(project.id)} className="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded">
                                                                ğŸ§®
                                                            </button>
                                                            <button onClick={() => setEditingProject(project.id)} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                                                                âœï¸ ØªØ¹Ø¯ÙŠÙ„
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {projects.map(project => (
                                    <button
                                        key={project.id}
                                        onClick={() => setSelectedProjectId(project.id)}
                                        className={`p-4 rounded-xl border-2 transition-all text-right ${
                                            selectedProjectId === project.id 
                                                ? 'border-red-600 bg-red-50 shadow-lg scale-105' 
                                                : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                    >
                                        <h3 className="font-bold text-lg text-gray-800 mb-1">{project.name}</h3>
                                        <p className="text-sm text-gray-600 mb-2">{project.description}</p>
                                        <div className="text-xs text-gray-500 space-y-1">
                                            <div className="bg-gray-100 px-2 py-1 rounded">Ø®ØµÙ… ÙƒØ§Ø´: {project.cashDiscountRate}%</div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Base System Modal */}
                        {showBaseSystemModal && currentProjectForBaseSystem && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden" onClick={() => setShowBaseSystemModal(false)}>
                                <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onClick={(e) => e.stopPropagation()}>
                                    <div className="bg-gradient-to-r from-gray-900 to-black px-8 py-6 text-white sticky top-0 rounded-t-2xl">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h2 className="text-2xl font-bold">ğŸ§® ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</h2>
                                                <p className="text-sm text-gray-300 mt-1">{currentProjectForBaseSystem.name}</p>
                                            </div>
                                            <button onClick={() => setShowBaseSystemModal(false)} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button>
                                        </div>
                                    </div>
                                    
                                    <div className="p-8 space-y-6">
                                        <div className="space-y-4">
                                            <div className="bg-gradient-to-r from-gray-100 to-gray-200 p-4 rounded-lg border-2 border-gray-300 mb-4">
                                                <h3 className="font-bold text-lg text-gray-800 mb-2">ğŸ’¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ø§Ù…Ø©</h3>
                                                <p className="text-sm text-gray-700">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø§Øª Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ®Ù‡Ø§ Ø¨Ø¯Ù‚Ø©</p>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ù…Ù‚Ø¯Ù…</label>
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="number"
                                                            value={tempBaseSystem.downPaymentValue}
                                                            onChange={(e) => setTempBaseSystem({...tempBaseSystem, downPaymentValue: parseFloat(e.target.value) || 0})}
                                                            className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500"
                                                            placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"
                                                        />
                                                        <select
                                                            value={tempBaseSystem.downPaymentIsPercentage ? 'percentage' : 'value'}
                                                            onChange={(e) => setTempBaseSystem({...tempBaseSystem, downPaymentIsPercentage: e.target.value === 'percentage'})}
                                                            className="px-4 py-3 border-2 border-gray-300 rounded-lg bg-white focus:border-red-500"
                                                        >
                                                            <option value="percentage">Ù†Ø³Ø¨Ø© %</option>
                                                            <option value="value">Ù‚ÙŠÙ…Ø© Ø¬</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</label>
                                                    <input
                                                        type="date"
                                                        value={tempBaseSystem.startDate || ''}
                                                        onChange={(e) => setTempBaseSystem({...tempBaseSystem, startDate: e.target.value})}
                                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500"
                                                    />
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©</label>
                                                    <input
                                                        type="number"
                                                        value={tempBaseSystem.quarterlyYears}
                                                        onChange={(e) => setTempBaseSystem({...tempBaseSystem, quarterlyYears: parseFloat(e.target.value) || 0})}
                                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                                    />
                                                </div>
                                            </div>

                                            {/* Annual Payments */}
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Ø¯ÙØ¹Ø§Øª Ø³Ù†ÙˆÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                                <div className="space-y-2">
                                                    {tempBaseSystem.annualPayments && tempBaseSystem.annualPayments.map((payment, index) => (
                                                        <div key={index} className="flex gap-2 items-center">
                                                            <input
                                                                type="number"
                                                                value={payment.value}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.annualPayments];
                                                                    updated[index].value = parseFloat(e.target.value) || 0;
                                                                    setTempBaseSystem({...tempBaseSystem, annualPayments: updated});
                                                                }}
                                                                className="flex-1 px-3 py-2 border rounded focus:border-red-500"
                                                                placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"
                                                            />
                                                            <select
                                                                value={payment.isPercentage ? 'percentage' : 'value'}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.annualPayments];
                                                                    updated[index].isPercentage = e.target.value === 'percentage';
                                                                    setTempBaseSystem({...tempBaseSystem, annualPayments: updated});
                                                                }}
                                                                className="px-3 py-2 border rounded bg-white focus:border-red-500"
                                                            >
                                                                <option value="percentage">Ù†Ø³Ø¨Ø© %</option>
                                                                <option value="value">Ù‚ÙŠÙ…Ø© Ø¬</option>
                                                            </select>
                                                            <input
                                                                type="date"
                                                                value={payment.date || ''}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.annualPayments];
                                                                    updated[index].date = e.target.value;
                                                                    setTempBaseSystem({...tempBaseSystem, annualPayments: updated});
                                                                }}
                                                                className="px-3 py-2 border rounded focus:border-red-500"
                                                                placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ®"
                                                            />
                                                            <button
                                                                onClick={() => {
                                                                    const updated = tempBaseSystem.annualPayments.filter((_, i) => i !== index);
                                                                    setTempBaseSystem({...tempBaseSystem, annualPayments: updated});
                                                                }}
                                                                className="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600"
                                                            >
                                                                âœ•
                                                            </button>
                                                        </div>
                                                    ))}
                                                    <button
                                                        onClick={() => {
                                                            const updated = [...(tempBaseSystem.annualPayments || []), { value: 10, isPercentage: true, type: 'Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ©', date: '' }];
                                                            setTempBaseSystem({...tempBaseSystem, annualPayments: updated});
                                                        }}
                                                        className="w-full bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600"
                                                    >
                                                        â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ©
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Semiannual Payments */}
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Ø¯ÙØ¹Ø§Øª Ù†ØµÙ Ø³Ù†ÙˆÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                                <div className="space-y-2">
                                                    {tempBaseSystem.semiannualPayments && tempBaseSystem.semiannualPayments.map((payment, index) => (
                                                        <div key={index} className="flex gap-2 items-center">
                                                            <input
                                                                type="number"
                                                                value={payment.value}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.semiannualPayments];
                                                                    updated[index].value = parseFloat(e.target.value) || 0;
                                                                    setTempBaseSystem({...tempBaseSystem, semiannualPayments: updated});
                                                                }}
                                                                className="flex-1 px-3 py-2 border rounded focus:border-red-500"
                                                                placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"
                                                            />
                                                            <select
                                                                value={payment.isPercentage ? 'percentage' : 'value'}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.semiannualPayments];
                                                                    updated[index].isPercentage = e.target.value === 'percentage';
                                                                    setTempBaseSystem({...tempBaseSystem, semiannualPayments: updated});
                                                                }}
                                                                className="px-3 py-2 border rounded bg-white focus:border-red-500"
                                                            >
                                                                <option value="percentage">Ù†Ø³Ø¨Ø© %</option>
                                                                <option value="value">Ù‚ÙŠÙ…Ø© Ø¬</option>
                                                            </select>
                                                            <input
                                                                type="date"
                                                                value={payment.date || ''}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.semiannualPayments];
                                                                    updated[index].date = e.target.value;
                                                                    setTempBaseSystem({...tempBaseSystem, semiannualPayments: updated});
                                                                }}
                                                                className="px-3 py-2 border rounded focus:border-red-500"
                                                                placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ®"
                                                            />
                                                            <button
                                                                onClick={() => {
                                                                    const updated = tempBaseSystem.semiannualPayments.filter((_, i) => i !== index);
                                                                    setTempBaseSystem({...tempBaseSystem, semiannualPayments: updated});
                                                                }}
                                                                className="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600"
                                                            >
                                                                âœ•
                                                            </button>
                                                        </div>
                                                    ))}
                                                    <button
                                                        onClick={() => {
                                                            const updated = [...(tempBaseSystem.semiannualPayments || []), { value: 5, isPercentage: true, type: 'Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©', date: '' }];
                                                            setTempBaseSystem({...tempBaseSystem, semiannualPayments: updated});
                                                        }}
                                                        className="w-full bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600"
                                                    >
                                                        â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Quarterly Payments - NEW */}
                                            <div className="bg-gradient-to-r from-gray-100 to-gray-200 p-4 rounded-lg border-2 border-gray-300">
                                                <label className="block text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                                    <span>ğŸ“…</span>
                                                    <span>Ø¯ÙØ¹Ø§Øª Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                                    <span className="text-xs bg-cyan-600 text-white px-2 py-1 rounded">Ø¬Ø¯ÙŠØ¯</span>
                                                </label>
                                                <div className="space-y-2">
                                                    {tempBaseSystem.quarterlyPayments && tempBaseSystem.quarterlyPayments.map((payment, index) => (
                                                        <div key={index} className="flex gap-2 items-center bg-white p-3 rounded-lg">
                                                            <input
                                                                type="number"
                                                                value={payment.value}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.quarterlyPayments];
                                                                    updated[index].value = parseFloat(e.target.value) || 0;
                                                                    setTempBaseSystem({...tempBaseSystem, quarterlyPayments: updated});
                                                                }}
                                                                className="flex-1 px-3 py-2 border-2 border-gray-300 rounded focus:border-red-500"
                                                                placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"
                                                            />
                                                            <select
                                                                value={payment.isPercentage ? 'percentage' : 'value'}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.quarterlyPayments];
                                                                    updated[index].isPercentage = e.target.value === 'percentage';
                                                                    setTempBaseSystem({...tempBaseSystem, quarterlyPayments: updated});
                                                                }}
                                                                className="px-3 py-2 border-2 border-gray-300 rounded bg-white focus:border-red-500"
                                                            >
                                                                <option value="percentage">Ù†Ø³Ø¨Ø© %</option>
                                                                <option value="value">Ù‚ÙŠÙ…Ø© Ø¬</option>
                                                            </select>
                                                            <input
                                                                type="date"
                                                                value={payment.date || ''}
                                                                onChange={(e) => {
                                                                    const updated = [...tempBaseSystem.quarterlyPayments];
                                                                    updated[index].date = e.target.value;
                                                                    setTempBaseSystem({...tempBaseSystem, quarterlyPayments: updated});
                                                                }}
                                                                className="px-3 py-2 border-2 border-gray-300 rounded focus:border-red-500"
                                                                placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ®"
                                                            />
                                                            <button
                                                                onClick={() => {
                                                                    const updated = tempBaseSystem.quarterlyPayments.filter((_, i) => i !== index);
                                                                    setTempBaseSystem({...tempBaseSystem, quarterlyPayments: updated});
                                                                }}
                                                                className="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition-all"
                                                            >
                                                                âœ•
                                                            </button>
                                                        </div>
                                                    ))}
                                                    <button
                                                        onClick={() => {
                                                            const updated = [...(tempBaseSystem.quarterlyPayments || []), { 
                                                                value: 5, 
                                                                isPercentage: true, 
                                                                type: 'Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©',
                                                                date: ''
                                                            }];
                                                            setTempBaseSystem({...tempBaseSystem, quarterlyPayments: updated});
                                                        }}
                                                        className="w-full bg-gradient-to-r from-red-600 to-red-700 text-white px-4 py-3 rounded-lg hover:from-cyan-600 hover:to-blue-600 font-bold transition-all"
                                                    >
                                                        â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©
                                                    </button>
                                                    <p className="text-xs text-gray-600 mt-2">ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ¯ Ù‚ÙŠÙ…Ø© ÙˆØªØ§Ø±ÙŠØ® ÙƒÙ„ Ø¯ÙØ¹Ø© Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„</p>
                                                </div>
                                            </div>

                                            <div className="flex gap-3">
                                                <button
                                                    onClick={() => {
                                                        const updatedProjects = projects.map(p => {
                                                            if (p.id === currentProjectForBaseSystem.id) {
                                                                return {
                                                                    ...p,
                                                                    baseSystem: tempBaseSystem
                                                                };
                                                            }
                                                            return p;
                                                        });
                                                        setProjects(updatedProjects);
                                                        setShowBaseSystemModal(false);
                                                        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ!');
                                                    }}
                                                    className="flex-1 bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl text-lg font-bold transition-all shadow-lg"
                                                >
                                                    âœ“ Ø­ÙØ¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                                                </button>
                                                <button
                                                    onClick={calculateDiscountRateForProject}
                                                    className="flex-1 bg-gradient-to-r from-gray-900 to-black hover:from-cyan-700 hover:to-blue-700 text-white px-8 py-4 rounded-xl text-lg font-bold transition-all shadow-lg"
                                                >
                                                    ğŸ§® Ø­ÙØ¸ + Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ…
                                                </button>
                                            </div>

                                            <div className="p-4 bg-blue-50 rounded-lg border border-gray-300">
                                                <p className="text-sm text-gray-700">
                                                    <strong>ğŸ’¡ Ù…Ù„Ø­ÙˆØ¸Ø©:</strong> Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ + Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ…"ØŒ Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Pattern Selection */}
                        <div className="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl shadow-lg p-6 border-2 border-gray-300 print-hidden">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">ğŸ’¡ Ø§Ø®ØªØ± Ù†Ù…Ø· Ø§Ù„Ø³Ø¯Ø§Ø¯</h2>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                {patterns.map(pattern => (
                                    <button
                                        key={pattern.id}
                                        onClick={() => setSelectedPattern(pattern.id)}
                                        className={`p-5 rounded-xl border-2 transition-all text-right ${
                                            selectedPattern === pattern.id 
                                                ? 'border-red-600 bg-red-50 shadow-lg scale-105' 
                                                : 'border-gray-200 hover:border-gray-300 bg-white'
                                        }`}
                                    >
                                        <div className="text-4xl mb-3">{pattern.icon}</div>
                                        <h3 className="font-bold text-xl text-gray-800 mb-2">{pattern.name}</h3>
                                        <p className="text-sm text-gray-600">{pattern.description}</p>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Input Settings */}
                        <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100 print-hidden">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">âš™ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¬)</label>
                                    <input type="number" value={unitValue} onChange={(e) => setUnitValue(parseFloat(e.target.value) || 0)}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Â²)</label>
                                    <input type="number" value={unitArea} onChange={(e) => setUnitArea(parseFloat(e.target.value) || 0)}
                                        placeholder="Ù…Ø«Ø§Ù„: 150"
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                    <input type="text" value={unitNumber} onChange={(e) => setUnitNumber(e.target.value)}
                                        placeholder="Ù…Ø«Ø§Ù„: A-101"
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ù…Ù‚Ø¯Ù…</label>
                                    <div className="flex gap-2">
                                        <input
                                            type="number"
                                            value={downPaymentValue}
                                            onChange={(e) => {
                                                const newValue = parseFloat(e.target.value) || 0;
                                                setDownPaymentValue(newValue);
                                                
                                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 5%
                                                if (unitValue > 0) {
                                                    const actualPercent = downPaymentIsPercentage 
                                                        ? newValue 
                                                        : (newValue / unitValue) * 100;
                                                    
                                                    if (actualPercent < 5) {
                                                        // Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø±Ø¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                                                    }
                                                }
                                            }}
                                            className={`flex-1 px-4 py-3 border-2 rounded-lg focus:outline-none ${
                                                unitValue > 0 && getSelectedProject() && (
                                                    downPaymentIsPercentage 
                                                        ? downPaymentValue < (getSelectedProject().minDownPaymentPercent || 5)
                                                        : (downPaymentValue / unitValue) * 100 < (getSelectedProject().minDownPaymentPercent || 5)
                                                ) 
                                                    ? 'border-red-500 bg-red-50' 
                                                    : 'border-gray-300 focus:border-red-500'
                                            }`}
                                            placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"
                                            min="0"
                                        />
                                        <select
                                            value={downPaymentIsPercentage ? 'percentage' : 'value'}
                                            onChange={(e) => setDownPaymentIsPercentage(e.target.value === 'percentage')}
                                            className="px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none bg-white"
                                        >
                                            <option value="percentage">Ù†Ø³Ø¨Ø© %</option>
                                            <option value="value">Ù‚ÙŠÙ…Ø© Ø¬</option>
                                        </select>
                                    </div>
                                    {/* ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ù‚Ø¯Ù… Ø¹Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ */}
                                    {unitValue > 0 && getSelectedProject() && (
                                        downPaymentIsPercentage 
                                            ? downPaymentValue < (getSelectedProject().minDownPaymentPercent || 5)
                                            : (downPaymentValue / unitValue) * 100 < (getSelectedProject().minDownPaymentPercent || 5)
                                    ) && (
                                        <div className="mt-2 p-3 bg-red-100 border border-red-400 rounded-lg">
                                            <p className="text-red-700 text-sm font-bold flex items-center gap-2">
                                                <span>âš ï¸</span>
                                                ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¨Ø§Ø¦Ø¹: Ø§Ù„Ù…Ù‚Ø¯Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙ‚Ù„ Ø¹Ù† {getSelectedProject().minDownPaymentPercent || 5}% Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                                            </p>
                                            <p className="text-red-600 text-xs mt-1">
                                                Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {(downPaymentIsPercentage ? downPaymentValue : (downPaymentValue / unitValue) * 100).toFixed(2)}% | 
                                                Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: {formatCurrency(unitValue * (getSelectedProject().minDownPaymentPercent || 5) / 100)}
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {getSelectedProject()?.baseSystem && unitValue > 0 && selectedPattern !== 'custom' && (
                                <div className="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-gray-300">
                                    <div className="flex items-center justify-between mb-2">
                                        <h3 className="font-bold text-lg text-gray-800">ğŸ“‹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                                        <button
                                            onClick={() => {
                                                calculateResults();
                                                setShowComparison(true);
                                            }}
                                            className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm"
                                        >
                                            ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø©
                                        </button>
                                    </div>
                                    <div className="text-sm text-gray-700 space-y-1">
                                        <p>â€¢ Ø§Ù„Ù…Ù‚Ø¯Ù…: {getSelectedProject().baseSystem.downPaymentIsPercentage ? `${getSelectedProject().baseSystem.downPaymentValue}%` : formatCurrency(getSelectedProject().baseSystem.downPaymentValue)}</p>
                                        {getSelectedProject().baseSystem.annualPayments && getSelectedProject().baseSystem.annualPayments.map((p, i) => (
                                            <p key={i}>â€¢ Ø¯ÙØ¹Ø© Ø³Ù†ÙˆÙŠØ© {i+1}: {p.isPercentage ? `${p.value}%` : formatCurrency(p.value)}</p>
                                        ))}
                                        {getSelectedProject().baseSystem.semiannualPayments && getSelectedProject().baseSystem.semiannualPayments.map((p, i) => (
                                            <p key={i}>â€¢ Ø¯ÙØ¹Ø© Ù†ØµÙ Ø³Ù†ÙˆÙŠØ© {i+1}: {p.isPercentage ? `${p.value}%` : formatCurrency(p.value)}</p>
                                        ))}
                                        <p>â€¢ Ø£Ù‚Ø³Ø§Ø· Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ©: {getSelectedProject().baseSystem.quarterlyYears} Ø³Ù†ÙˆØ§Øª</p>
                                    </div>
                                </div>
                            )}

                            {(selectedPattern === 'equal' || selectedPattern === 'decreasing' || selectedPattern === 'graduated') && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Ù…Ø¯Ø© Ø§Ù„ØªÙ‚Ø³ÙŠØ· (Ø³Ù†ÙˆØ§Øª)</label>
                                            <input type="number" value={numberOfYears} onChange={(e) => setNumberOfYears(parseFloat(e.target.value) || 0)}
                                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">ØªØ±Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</label>
                                            <select value={frequency} onChange={(e) => setFrequency(parseInt(e.target.value))}
                                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">
                                                <option value="12">Ø´Ù‡Ø±ÙŠ</option>
                                                <option value="4">Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                                                <option value="2">Ù†ØµÙ Ø³Ù†ÙˆÙŠ</option>
                                                <option value="1">Ø³Ù†ÙˆÙŠ</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">ğŸ“† ÙŠÙˆÙ… Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø³Ø·</label>
                                            <div className="flex gap-3">
                                                <label className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg cursor-pointer transition-all border-2 ${installmentDay === 1 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-300 hover:border-blue-400'}`}>
                                                    <input
                                                        type="radio"
                                                        name="installmentDay"
                                                        value="1"
                                                        checked={installmentDay === 1}
                                                        onChange={() => setInstallmentDay(1)}
                                                        className="hidden"
                                                    />
                                                    <span className="font-bold">ÙŠÙˆÙ… 1</span>
                                                </label>
                                                <label className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg cursor-pointer transition-all border-2 ${installmentDay === 15 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-300 hover:border-blue-400'}`}>
                                                    <input
                                                        type="radio"
                                                        name="installmentDay"
                                                        value="15"
                                                        checked={installmentDay === 15}
                                                        onChange={() => setInstallmentDay(15)}
                                                        className="hidden"
                                                    />
                                                    <span className="font-bold">ÙŠÙˆÙ… 15</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    {selectedPattern === 'decreasing' && (
                                        <div className="p-4 bg-emerald-50 rounded-lg border-2 border-emerald-200">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†Ø§Ù‚Øµ (% ÙƒÙ„ ÙØªØ±Ø©)</label>
                                            <input type="number" value={decreaseRate} onChange={(e) => setDecreaseRate(parseFloat(e.target.value) || 0)}
                                                className="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg" />
                                        </div>
                                    )}

                                    {selectedPattern === 'graduated' && (
                                        <div className="p-4 bg-purple-50 rounded-lg border-2 border-gray-300">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© (% ÙƒÙ„ ÙØªØ±Ø©)</label>
                                            <input type="number" value={growthRate} onChange={(e) => setGrowthRate(parseFloat(e.target.value) || 0)}
                                                className="w-full px-4 py-3 border-2 border-purple-300 rounded-lg" />
                                        </div>
                                    )}

                                    {/* Annual Payments */}
                                    <div className="p-4 bg-green-50 rounded-lg border-2 border-green-200">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="font-bold text-lg flex items-center gap-2">
                                                <span>ğŸ“…</span> Ø¯ÙØ¹Ø§Øª Ø³Ù†ÙˆÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                                            </h3>
                                            <button onClick={addAnnualPayment} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                                                â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                                            </button>
                                        </div>

                                        {annualPayments.length > 0 && (
                                            <div className="space-y-3">
                                                {annualPayments.map((payment) => (
                                                    <div key={payment.id} className="bg-white p-3 rounded-lg border border-green-300">
                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                                            <input
                                                                type="text"
                                                                value={payment.type}
                                                                onChange={(e) => updateAnnualPayment(payment.id, 'type', e.target.value)}
                                                                placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©"
                                                                className="px-3 py-2 border rounded"
                                                            />
                                                            <div className="flex gap-2">
                                                                <input
                                                                    type="number"
                                                                    value={payment.value}
                                                                    onChange={(e) => updateAnnualPayment(payment.id, 'value', parseFloat(e.target.value))}
                                                                    placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"
                                                                    className="flex-1 px-3 py-2 border rounded"
                                                                />
                                                                <select
                                                                    value={payment.isPercentage ? 'percentage' : 'value'}
                                                                    onChange={(e) => updateAnnualPayment(payment.id, 'isPercentage', e.target.value === 'percentage')}
                                                                    className="px-3 py-2 border rounded bg-white"
                                                                >
                                                                    <option value="percentage">Ù†Ø³Ø¨Ø© %</option>
                                                                    <option value="value">Ù‚ÙŠÙ…Ø© Ø¬</option>
                                                                </select>
                                                            </div>
                                                            <input
                                                                type="date"
                                                                value={payment.date}
                                                                onChange={(e) => updateAnnualPayment(payment.id, 'date', e.target.value)}
                                                                className="px-3 py-2 border rounded"
                                                            />
                                                            <button onClick={() => deleteAnnualPayment(payment.id)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded">
                                                                ğŸ—‘ï¸
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* Semiannual Payments */}
                                    <div className="p-4 bg-blue-50 rounded-lg border-2 border-gray-300">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="font-bold text-lg flex items-center gap-2">
                                                <span>ğŸ“…</span> Ø¯ÙØ¹Ø§Øª Ù†ØµÙ Ø³Ù†ÙˆÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                                            </h3>
                                            <button onClick={addSemiannualPayment} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                                                â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                                            </button>
                                        </div>

                                        {semiannualPayments.length > 0 && (
                                            <div className="space-y-3">
                                                {semiannualPayments.map((payment) => (
                                                    <div key={payment.id} className="bg-white p-3 rounded-lg border border-blue-300">
                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                                            <input
                                                                type="text"
                                                                value={payment.type}
                                                                onChange={(e) => updateSemiannualPayment(payment.id, 'type', e.target.value)}
                                                                placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©"
                                                                className="px-3 py-2 border rounded"
                                                            />
                                                            <div className="flex gap-2">
                                                                <input
                                                                    type="number"
                                                                    value={payment.value}
                                                                    onChange={(e) => updateSemiannualPayment(payment.id, 'value', parseFloat(e.target.value))}
                                                                    placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"
                                                                    className="flex-1 px-3 py-2 border rounded"
                                                                />
                                                                <select
                                                                    value={payment.isPercentage ? 'percentage' : 'value'}
                                                                    onChange={(e) => updateSemiannualPayment(payment.id, 'isPercentage', e.target.value === 'percentage')}
                                                                    className="px-3 py-2 border rounded bg-white"
                                                                >
                                                                    <option value="percentage">Ù†Ø³Ø¨Ø© %</option>
                                                                    <option value="value">Ù‚ÙŠÙ…Ø© Ø¬</option>
                                                                </select>
                                                            </div>
                                                            <input
                                                                type="date"
                                                                value={payment.date}
                                                                onChange={(e) => updateSemiannualPayment(payment.id, 'date', e.target.value)}
                                                                className="px-3 py-2 border rounded"
                                                            />
                                                            <button onClick={() => deleteSemiannualPayment(payment.id)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded">
                                                                ğŸ—‘ï¸
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</label>
                                        <input
                                            type="date"
                                            value={quarterlyStartDate}
                                            onChange={(e) => setQuarterlyStartDate(e.target.value)}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                        />
                                    </div>
                                </div>
                            )}

                            {selectedPattern === 'custom' && (
                                <div className="space-y-6">
                                    <div className="p-4 bg-amber-50 rounded-lg border-2 border-amber-200">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="font-bold text-lg">Ø¯ÙØ¹Ø§Øª Ù…Ø®ØµØµØ©</h3>
                                            <button onClick={addCustomPayment} className="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm">
                                                â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                                            </button>
                                        </div>

                                        {customPayments.length > 0 && (
                                            <div className="space-y-3">
                                                {customPayments.map((payment) => (
                                                    <div key={payment.id} className="bg-white p-3 rounded-lg border border-amber-300">
                                                        <div className="grid grid-cols-1 md:grid-cols-6 gap-3">
                                                            <input
                                                                type="text"
                                                                value={payment.type}
                                                                onChange={(e) => updateCustomPayment(payment.id, 'type', e.target.value)}
                                                                placeholder="Ø§Ø³Ù…"
                                                                className="px-3 py-2 border rounded"
                                                            />
                                                            <div className="flex gap-2">
                                                                <input
                                                                    type="number"
                                                                    value={payment.value}
                                                                    onChange={(e) => updateCustomPayment(payment.id, 'value', parseFloat(e.target.value))}
                                                                    placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"
                                                                    className="flex-1 px-3 py-2 border rounded"
                                                                />
                                                                <select
                                                                    value={payment.isPercentage ? 'percentage' : 'value'}
                                                                    onChange={(e) => updateCustomPayment(payment.id, 'isPercentage', e.target.value === 'percentage')}
                                                                    className="px-3 py-2 border rounded bg-white"
                                                                >
                                                                    <option value="percentage">Ù†Ø³Ø¨Ø© %</option>
                                                                    <option value="value">Ù‚ÙŠÙ…Ø© Ø¬</option>
                                                                </select>
                                                            </div>
                                                            <select
                                                                value={payment.frequency}
                                                                onChange={(e) => updateCustomPayment(payment.id, 'frequency', e.target.value)}
                                                                className="px-3 py-2 border rounded"
                                                            >
                                                                <option value="once">Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                                                                <option value="quarterly">Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ (ÙƒÙ„ 3 Ø´Ù‡ÙˆØ±)</option>
                                                                <option value="semiannual">Ù†ØµÙ Ø³Ù†ÙˆÙŠ (ÙƒÙ„ 6 Ø´Ù‡ÙˆØ±)</option>
                                                                <option value="annual">Ø³Ù†ÙˆÙŠ (ÙƒÙ„ 12 Ø´Ù‡Ø±)</option>
                                                            </select>
                                                            {payment.frequency !== 'once' && (
                                                                <div className="flex items-center gap-2">
                                                                    <input
                                                                        type="number"
                                                                        min="1"
                                                                        value={payment.numberOfPayments || 1}
                                                                        onChange={(e) => updateCustomPayment(payment.id, 'numberOfPayments', parseInt(e.target.value) || 1)}
                                                                        placeholder="Ø§Ù„Ø¹Ø¯Ø¯"
                                                                        className="w-20 px-3 py-2 border rounded"
                                                                    />
                                                                    <span className="text-sm text-gray-500">Ø¯ÙØ¹Ø©</span>
                                                                </div>
                                                            )}
                                                            <input
                                                                type="date"
                                                                value={payment.startDate}
                                                                onChange={(e) => updateCustomPayment(payment.id, 'startDate', e.target.value)}
                                                                className="px-3 py-2 border rounded"
                                                            />
                                                            <button onClick={() => deleteCustomPayment(payment.id)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded">
                                                                ğŸ—‘ï¸
                                                            </button>
                                                        </div>
                                                        {payment.frequency !== 'once' && (
                                                            <div className="mt-2 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                                                                ğŸ’¡ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ {payment.numberOfPayments || 1} Ø¯ÙØ¹Ø© Ø¨Ù‚ÙŠÙ…Ø© {payment.isPercentage ? `${payment.value}%` : formatCurrency(payment.value)} 
                                                                {payment.frequency === 'quarterly' && ' ÙƒÙ„ 3 Ø´Ù‡ÙˆØ±'}
                                                                {payment.frequency === 'semiannual' && ' ÙƒÙ„ 6 Ø´Ù‡ÙˆØ±'}
                                                                {payment.frequency === 'annual' && ' ÙƒÙ„ Ø³Ù†Ø©'}
                                                                {' '}Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† {payment.startDate || 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡'}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© (Ø³Ù†ÙˆØ§Øª)</label>
                                            <input
                                                type="number"
                                                value={quarterlyYears}
                                                onChange={(e) => setQuarterlyYears(parseFloat(e.target.value) || 0)}
                                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</label>
                                            <input
                                                type="date"
                                                value={customQuarterlyStartDate}
                                                onChange={(e) => setCustomQuarterlyStartDate(e.target.value)}
                                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">ğŸ“† ÙŠÙˆÙ… Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø³Ø·</label>
                                            <div className="flex gap-3">
                                                <label className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg cursor-pointer transition-all border-2 ${installmentDay === 1 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-300 hover:border-blue-400'}`}>
                                                    <input
                                                        type="radio"
                                                        name="installmentDayCustom"
                                                        value="1"
                                                        checked={installmentDay === 1}
                                                        onChange={() => setInstallmentDay(1)}
                                                        className="hidden"
                                                    />
                                                    <span className="font-bold">ÙŠÙˆÙ… 1</span>
                                                </label>
                                                <label className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg cursor-pointer transition-all border-2 ${installmentDay === 15 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-300 hover:border-blue-400'}`}>
                                                    <input
                                                        type="radio"
                                                        name="installmentDayCustom"
                                                        value="15"
                                                        checked={installmentDay === 15}
                                                        onChange={() => setInstallmentDay(15)}
                                                        className="hidden"
                                                    />
                                                    <span className="font-bold">ÙŠÙˆÙ… 15</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Ø®ÙŠØ§Ø± ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚Ø³Ø· - Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· */}
                            {isAdmin && (
                                <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-4 border-2 border-amber-200">
                                    <label className="block text-sm font-bold text-gray-700 mb-3">
                                        <span className="flex items-center gap-2">
                                            <span>ğŸ¯</span>
                                            Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚Ø³Ø· (Ù„Ù„Ù…Ø¯ÙŠØ±)
                                        </span>
                                    </label>
                                    <div className="mb-3 p-2 bg-green-100 rounded-lg border border-green-300">
                                        <p className="text-green-700 text-sm">
                                            âœ… <strong>ØªÙ„Ù‚Ø§Ø¦ÙŠ:</strong> ÙŠØªÙ… ØªÙ‚Ø±ÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø£Ù‚Ø±Ø¨ 100 Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                                        </p>
                                    </div>
                                    <p className="text-sm text-gray-600 mb-2">ØªÙ‚Ø±ÙŠØ¨ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</p>
                                    <div className="flex flex-wrap gap-3">
                                        <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer transition-all ${roundingOption === 'none' ? 'bg-amber-500 text-white' : 'bg-white border-2 border-gray-300 hover:border-amber-400'}`}>
                                            <input
                                                type="radio"
                                                name="rounding"
                                                value="none"
                                                checked={roundingOption === 'none'}
                                                onChange={(e) => setRoundingOption(e.target.value)}
                                                className="hidden"
                                            />
                                            <span className="font-medium">Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨ Ø¥Ø¶Ø§ÙÙŠ</span>
                                        </label>
                                        <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer transition-all ${roundingOption === '500' ? 'bg-amber-500 text-white' : 'bg-white border-2 border-gray-300 hover:border-amber-400'}`}>
                                            <input
                                                type="radio"
                                                name="rounding"
                                                value="500"
                                                checked={roundingOption === '500'}
                                                onChange={(e) => setRoundingOption(e.target.value)}
                                                className="hidden"
                                            />
                                            <span className="font-medium">Ø£Ù‚Ø±Ø¨ 500 Ø¬ â†‘</span>
                                        </label>
                                        <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer transition-all ${roundingOption === '1000' ? 'bg-amber-500 text-white' : 'bg-white border-2 border-gray-300 hover:border-amber-400'}`}>
                                            <input
                                                type="radio"
                                                name="rounding"
                                                value="1000"
                                                checked={roundingOption === '1000'}
                                                onChange={(e) => setRoundingOption(e.target.value)}
                                                className="hidden"
                                            />
                                            <span className="font-medium">Ø£Ù‚Ø±Ø¨ 1000 Ø¬ â†‘</span>
                                        </label>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2">
                                        ğŸ’¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙˆÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø¯ÙˆØ±ÙŠØ© ÙÙ‚Ø·ØŒ ÙˆÙ„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                                    </p>
                                </div>
                            )}

                            <div className="flex justify-center mt-6">
                                <button onClick={calculateResults}
                                    className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-12 py-4 rounded-xl text-lg font-bold transition-all shadow-lg hover:shadow-xl">
                                    ğŸ§® Ø§Ø­Ø³Ø¨ Ø®Ø·Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯
                                </button>
                            </div>
                        </div>

                        {/* Results Display */}
                        {results && (
                            <div className="space-y-6">
                                {/* Print Header */}
                                <div className="print-only">
                                    <div className="text-center border-b-4 border-indigo-600 pb-6 mb-6">
                                        <h1 className="text-3xl font-bold text-red-600 mb-2">Ø´Ø±ÙƒØ© Ø¨ÙŠØªØ§ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</h1>
                                        <p className="text-xl text-gray-700">BETA SMART FINANCE | Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø³ÙŠØ· Ø§Ù„Ù…Ø±Ù†</p>
                                        <p className="text-sm text-gray-600 mt-2">Ø§Ù„ØªØ§Ø±ÙŠØ®: {new Date().toLocaleDateString('ar-EG')}</p>
                                    </div>
                                </div>

                                {/* Summary Card */}
                                <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-lg p-6 border-2 border-green-200 print-container">
                                    <div className="flex items-center justify-between mb-4 print-hidden">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-800">âœ… Ø®Ø·Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯ - {results.patternName}</h2>
                                        </div>
                                        <div className="flex gap-3">
                                            {baseSystemResults && (
                                                <button onClick={() => setShowComparison(true)} className="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg">
                                                    ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ØªÙ‚Ø¯Ù…Ø©
                                                </button>
                                            )}
                                            <button onClick={handlePrint} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg flex items-center gap-2">
                                                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
                                            </button>
                                        </div>
                                    </div>

                                    <div className="print-only mb-6">
                                        <div className="grid grid-cols-2 gap-4 text-lg">
                                            <div><span className="font-bold">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</span> {getSelectedProject()?.name}</div>
                                            <div><span className="font-bold">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</span> {unitNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                            <div><span className="font-bold">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆØ­Ø¯Ø©:</span> {formatCurrency(unitValue)}</div>
                                            <div><span className="font-bold">Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¯Ø§Ø¯:</span> {results.patternName}</div>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="bg-white rounded-lg p-4 text-center shadow">
                                            <p className="text-sm text-gray-600 mb-1">Ø§Ù„Ù…Ù‚Ø¯Ù…</p>
                                            <p className="text-xl font-bold text-gray-800">{formatCurrency(results.downPayment)}</p>
                                        </div>
                                        <div className="bg-white rounded-lg p-4 text-center shadow">
                                            <p className="text-sm text-gray-600 mb-1">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø£ÙˆÙ„</p>
                                            <p className="text-xl font-bold text-red-600">
                                                {formatCurrency(results.installmentAmount || results.baseInstallment || results.schedule[results.schedule.length - 1]?.amount || 0)}
                                            </p>
                                        </div>
                                        <div className="bg-white rounded-lg p-4 text-center shadow">
                                            <p className="text-sm text-gray-600 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</p>
                                            <p className="text-xl font-bold text-gray-800">{results.schedule.length - 1}</p>
                                        </div>
                                        <div className="bg-white rounded-lg p-4 text-center shadow">
                                            <p className="text-sm text-gray-600 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
                                            <p className="text-xl font-bold text-gray-800">{formatCurrency(results.summary.totalPaid)}</p>
                                        </div>
                                    </div>

                                    {unitArea > 0 && (
                                        <div className="mt-4 bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl shadow-lg p-6 border-2 border-gray-300 print-hidden">
                                            <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                                <span>ğŸ“</span> ØªØ­Ù„ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ±
                                            </h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <div className="bg-white rounded-lg p-4 shadow-md">
                                                    <p className="text-sm text-gray-600 mb-2">Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ± ÙƒØ§Ø´</p>
                                                    <p className="text-2xl font-bold text-green-600">
                                                        {formatCurrency((unitValue * (100 - (getSelectedProject()?.cashDiscountRate || 0)) / 100) / unitArea)}
                                                    </p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        Ø¨Ø¹Ø¯ Ø®ØµÙ… {getSelectedProject()?.cashDiscountRate || 0}%
                                                    </p>
                                                </div>
                                                <div className="bg-white rounded-lg p-4 shadow-md">
                                                    <p className="text-sm text-gray-600 mb-2">Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ± ØªÙ‚Ø³ÙŠØ·</p>
                                                    <p className="text-2xl font-bold text-red-600">
                                                        {formatCurrency(results.summary.totalPaid / unitArea)}
                                                    </p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„ØªÙ‚Ø³ÙŠØ·
                                                    </p>
                                                </div>
                                                <div className="bg-white rounded-lg p-4 shadow-md">
                                                    <p className="text-sm text-gray-600 mb-2">Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ±</p>
                                                    <p className="text-2xl font-bold text-orange-600">
                                                        {formatCurrency((results.summary.totalPaid / unitArea) - ((unitValue * (100 - (getSelectedProject()?.cashDiscountRate || 0)) / 100) / unitArea))}
                                                    </p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        Ù†Ø³Ø¨Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©: {(((results.summary.totalPaid / unitArea) / ((unitValue * (100 - (getSelectedProject()?.cashDiscountRate || 0)) / 100) / unitArea) - 1) * 100).toFixed(2)}%
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="mt-4 p-4 bg-white rounded-lg border-2 border-cyan-100">
                                                <div className="grid grid-cols-2 gap-4 text-sm">
                                                    <div>
                                                        <p className="text-gray-600">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ÙƒØ§Ø´</p>
                                                        <p className="font-bold text-green-700">
                                                            {formatCurrency(unitValue * (100 - (getSelectedProject()?.cashDiscountRate || 0)) / 100)}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-600">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ØªÙ‚Ø³ÙŠØ·</p>
                                                        <p className="font-bold text-indigo-700">
                                                            {formatCurrency(results.summary.totalPaid)}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-600">Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>
                                                        <p className="font-bold text-orange-700">
                                                            {formatCurrency(results.summary.totalPaid - (unitValue * (100 - (getSelectedProject()?.cashDiscountRate || 0)) / 100))}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-600">Ù†Ø³Ø¨Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                                                        <p className="font-bold text-orange-700">
                                                            {((results.summary.totalPaid / (unitValue * (100 - (getSelectedProject()?.cashDiscountRate || 0)) / 100) - 1) * 100).toFixed(2)}%
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* ADMIN ONLY: Technical Details */}
                                    {isAdmin && (
                                        <div className="mt-4 p-4 bg-white rounded-lg shadow print-hidden">
                                            <h3 className="font-bold text-gray-800 mb-2">ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)</h3>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                                <div>
                                                    <p className="text-gray-600">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒØ§Ø´</p>
                                                    <p className="font-bold">{formatCurrency(results.verification.cashValue)}</p>
                                                </div>
                                                <div>
                                                    <p className="text-gray-600">XNPV Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</p>
                                                    <p className="font-bold text-green-600">{formatCurrency(results.verification.totalPV)}</p>
                                                </div>
                                                <div>
                                                    <p className="text-gray-600">Ø§Ù„ÙØ±Ù‚</p>
                                                    <p className={`font-bold ${Math.abs(results.verification.difference) < 1000 ? 'text-green-600' : 'text-red-600'}`}>
                                                        {formatCurrency(Math.abs(results.verification.difference))}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-gray-600">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø®ØµÙ…</p>
                                                    <p className="font-bold text-red-600">
                                                        {(getSelectedProject()?.discountRate || 0).toFixed(3)}%
                                                        {getSelectedProject()?.discountRateMode === 'auto' && <span className="text-xs ml-1">(Ù…Ø­Ø³ÙˆØ¨)</span>}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Payment Schedule */}
                                <div className="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-gray-100 print-container">
                                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 print-hidden">
                                        <h3 className="text-xl font-bold text-white">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</h3>
                                    </div>
                                    
                                    <div className="print-only bg-indigo-600 px-6 py-3">
                                        <h3 className="text-xl font-bold text-white">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
                                    </div>

                                    <div className="p-6">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-gray-100">
                                                    <tr>
                                                        <th className="px-4 py-3 text-right font-bold border">Ù…</th>
                                                        <th className="px-4 py-3 text-right font-bold border">Ø§Ù„Ù†ÙˆØ¹</th>
                                                        <th className="px-4 py-3 text-right font-bold border">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                        <th className="px-4 py-3 text-right font-bold border">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-200">
                                                    {results.schedule.map((payment) => (
                                                        <tr key={payment.id} className="hover:bg-gray-50">
                                                            <td className="px-4 py-3 border">{payment.id + 1}</td>
                                                            <td className="px-4 py-3 font-medium border">{payment.type}</td>
                                                            <td className="px-4 py-3 border">{formatDate(payment.date)}</td>
                                                            <td className="px-4 py-3 font-bold border">{formatCurrency(payment.amount)}</td>
                                                        </tr>
                                                    ))}
                                                    <tr className="bg-gray-200 font-bold">
                                                        <td colSpan="3" className="px-4 py-3 border">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                                                        <td className="px-4 py-3 border">{formatCurrency(results.summary.totalPaid)}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        <div className="print-only mt-8 pt-6 border-t-2 border-gray-300">
                                            <div className="grid grid-cols-2 gap-8">
                                                <div className="text-center">
                                                    <p className="mb-12">_____________________</p>
                                                    <p className="font-bold">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                                                </div>
                                                <div className="text-center">
                                                    <p className="mb-12">_____________________</p>
                                                    <p className="font-bold">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ©</p>
                                                </div>
                                            </div>
                                            <div className="text-center mt-8 text-sm text-gray-600">
                                                <p>Ø´Ø±ÙƒØ© Ø¨ÙŠØªØ§ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ - BETA SMART FINANCE</p>
                                                <p className="mt-1">Ù‡Ø§ØªÙ: 19231 - info@betadevelopments.com</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Enhanced Comparison Modal */}
                        <ComparisonModal />

                        {/* Footer */}
                        <div className="text-center text-gray-600 text-sm mt-8 pb-8 print-hidden">
                            <p className="font-bold text-red-600 text-lg">Ø´Ø±ÙƒØ© Ø¨ÙŠØªØ§ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</p>
                            <p className="mt-1">BETA SMART FINANCE | Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø³ÙŠØ· Ø§Ù„Ù…Ø±Ù† - Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© - Ø®Ø¯Ù…Ø© Ù…ØªÙ…ÙŠØ²Ø©</p>
                            <p className="mt-2">Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<BetaSmartFinance />, document.getElementById('root'));
    </script>
</body>
</html>
